<!doctype html><html lang=es-mx><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Joshua Haase</title>
<link rel=stylesheet media=screen href=https://joshua.haase.mx/css/theme.min.2ee1317322f9eb9b2ef0a618d19b20e38c11f5f9c310751400a45db225dd2626.css integrity="sha256-LuExcyL565su8KYY0Zsg44wR9fnDEHUUAKRdsiXdJiY="></head><body><main><article><nav id=TableOfContents><ul><li><a href=#lecciones-aprendidas-del-primer-capture-the-flag-que-hice>Lecciones aprendidas del primer <em>Capture the Flag</em> que hice</a></li><li><a href=#diseñando-los-juegos-para-el-aprendizaje>Diseñando los juegos para el aprendizaje</a></li><li><a href=#desactivar-medidas-de-seguridad>Desactivar medidas de seguridad</a></li><li><a href=#cómo-se-protegen-los-programas>Cómo se protegen los programas</a></li><li><a href=#cómo-demostrar-programas-vulnerables>Cómo demostrar programas vulnerables</a></li><li><a href=#ejecutar-programas-desde-la-pila>Ejecutar programas desde la pila</a></li><li><a href=#cómo-aprovechar-la-vulnerabilidad-de-los-programas-para-ejecutar-código-arbitrario>Cómo aprovechar la vulnerabilidad de los programas para ejecutar código arbitrario</a></li><li><a href=#cómo-atacar-la-memoria-cuándo-está-protegida>Cómo atacar la memoria cuándo está protegida</a></li><li><a href=#cómo-evitar-que-se-diagnostiquen-los-programas>Cómo evitar que se diagnostiquen los programas</a></li><li><a href=#herramientas-para-programar-con-código-existente>Herramientas para programar con código existente</a></li><li><a href=#minimizar-el-tamaño-de-los-ctf>Minimizar el tamaño de los CTF</a></li></ul><ul><li><a href=#restringir-permisos-de-usuario-compartido-en-servidor>Restringir permisos de usuario compartido en servidor</a></li><li><a href=#generar-sitio-privado-para-documentación-de-estudiantes>Generar sitio privado para documentación de estudiantes</a></li></ul><ul><li><a href=#generar-sitio-de-documentación-para-taller-de-ciberseguridad>Generar sitio de documentación para taller de ciberseguridad</a></li><li><a href=#-cómo-compartir-control-en-aplicaciones-gráficas>☑ Cómo compartir control en aplicaciones gráficas</a></li><li><a href=#problemas-con-xpra>Problemas con xpra</a></li><li><a href=#herramientas-para-visualizar-la-memoria-urlhttpsstackoverflowcomquestions5752605tool-to-clearly-visualize-memory-layout-of-a-c-program>Herramientas para visualizar la memoria [@url:https://stackoverflow.com/questions/5752605/tool-to-clearly-visualize-memory-layout-of-a-c-program]</a></li><li><a href=#dirigir-el-entrenamiento-hacia-binarios-y-cómo-funcionan-las-computadoras>Dirigir el entrenamiento hacia binarios y cómo funcionan las computadoras</a></li></ul></nav><p>La metodología para el diseño de los retos se utilizó para el
<a href=https://preuniversitarios.ibero.mx/CSAW/ target=_blank rel=noopener>Cyber Security Challenge for High School</a>.</p><p>Se encontró que implementación técnica de los juegos
puede afectar el objetivo de aprendizaje:</p><ul><li>Pueden existir atajos para resolver los juegos.</li></ul><h2 id=lecciones-aprendidas-del-primer-capture-the-flag-que-hice><a href=#lecciones-aprendidas-del-primer-capture-the-flag-que-hice alt>Lecciones aprendidas del primer <em>Capture the Flag</em> que hice</a> <a href=# alt="Regresar al inicio">↑</a></h2><ol><li><p>Si se va a publicar el binario para permitir pruebas locales,
es muy <strong>importante separar las banderas del binario</strong>,
o cambiarlas en el binario publicado.</p><p>No hacer esto puede eliminar el aprendizaje en el juego,
porque cualquiera abre un block de notas o usa <code>strings</code>.</p><p>De igual manera,
leí que se recomienda no usar un indicativo
que haga evidente las banderas como <code>\flag{}</code>
porque la gente podría usar <code>grep</code>.</p></li><li><p>Para simplificar los retos
conviene <a href=./aplicaciones-vulnerables-para-poc/>desactivar las opciones de seguridad del compilador</a>
y eliminar las optimizaciones del código.</p><pre tabindex=0><code>CFLAGS=-fno-stack-protector -no-pie -ggdb3 -O0
</code></pre></li><li><p>Al intentar explotar <a href>un binario con protecciones desactivadas</a>,
se puede quedar el programa colgado y utilizando el máximo de los recursos.
Por lo tanto conviene limitar la ejecución del código.</p><pre tabindex=0><code>prlimit -t=${TIEMPO_RAZONABLE_PARA_EJECUTAR} aplicación
</code></pre><p>(Tengo entendido que este es tiempo efectivo de ejecución
y no hay problema si el programa está esperando input;
no he puesto a prueba esta hipótesis.)</p></li><li><p>Las aplicaciones usan un buffer para imprimir en <code>stdout</code>.
Si la aplicación no limpia el buffer al enviar la bandera,
puede que el jugador resuelva correctamente pero no obtenga la bandera.</p></li></ol><h2 id=diseñando-los-juegos-para-el-aprendizaje><a href=#dise%c3%b1ando-los-juegos-para-el-aprendizaje alt>Diseñando los juegos para el aprendizaje</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Algo que me encanta de plataformas de juegos como [Over The Wire](<a href=https://overthewire.org/ target=_blank rel=noopener>https://overthewire.org/</a> &ldquo;The wargames OverTheWire can help you to learn and practice security concepts in the form of fun-filled games.&rdquo;
(puedes empezar por <a href=https://overthewire.org/wargames/bandit/ title="War Games over the Wire" target=_blank rel=noopener>bandit</a>)
es que plantea retos para que aprendas haciendo
y te ofrece las pistas suficientes para que vayas aprendiendo
a usar tu computadora más allá del <em>point and click</em>.</p><p>En el caso del segundo juego «natas»,
cuando lo intenté con el <a href=/csaw/ title="Yo quería llamarlo Taller del Hacker Ético.">taller de ciberseguridad</a>
mis alumnos han tenido problemas porque en algunos casos la dificultad
salta de un problema súper sencillo a el nivel más alto de exploración del problema.</p><p>Y aunque es divertido para un hacker que ya tiene algo de experiencia
y al menos tiene una noción de qué hay que hacer,
es frustrante pasar sesione explorando sin avance aparente.</p><p>Entonces he querido <a href=/techno/aplicaciones-vulnerables-para-poc/ title="Mis notas para hacer aplicaciones vulnerables">hacer un camino de victorias intermedias</a>
para aprender los conceptos desde una perspectiva práctica,
<a href=/techno/aplicacines-vulnerables-para-poc/ title="Mis notas acerca de qué tomar en cuenta cuándo haces retos de CTF.">con ayudas en el camino</a>.</p><h2 id=desactivar-medidas-de-seguridad><a href=#desactivar-medidas-de-seguridad alt>Desactivar medidas de seguridad</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>La mayoría de las vulnerabilidades en los programas son errores de gestión de memoria.</p><p>Para enseñar cómo funcionan los ataques de desbordamiento de la pila,
es importante entender <a href=https://www.geeksforgeeks.org/memory-layout-of-c-program/ target=_blank rel=noopener>cómo guardan información los programas</a>.</p><p><a href=https://www.eecs.umich.edu/courses/eecs588/static/stack_smashing.pdf target=_blank rel=noopener>«Smashing the stack for fun and profit»</a>
explica relativamente bien cómo funciona todo.</p><p><a href=https://web.archive.org/web/20060919233718/https://inst.eecs.berkeley.edu/~cs164/sp05/ia32-refs/ia32-chapter-three.pdf target=_blank rel=noopener>Cómo funciona la pila en ia32</a>..</p><p><a href=https://eli.thegreenplace.net/2011/09/06/stack-frame-layout-on-x86-64 target=_blank rel=noopener>Cómo funciona la pila en x86_64</a>.</p><p><a href=https://courses.cs.washington.edu/courses/cse351/18wi/lectures/10/CSE351-L10-x86-III_18wi.pdf target=_blank rel=noopener>Más acerca de como funciona el stack en x86-64</a>.</p><h2 id=cómo-se-protegen-los-programas><a href=#c%c3%b3mo-se-protegen-los-programas alt>Cómo se protegen los programas</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Al compilar los programas se pueden activar varias opciones de protección.</p><p><a href=https://mcuoneclipse.com/2019/09/28/stack-canaries-with-gcc-checking-for-stack-overflow-at-runtime/ title="Así funcionan los Canarios de la Pila." target=_blank rel=noopener><code>-stack-protection</code></a>: verifica que las variables se escriban en su lugar.</p><p><code>-pie</code>: genera código que puede moverse en la memoria.</p><p><code>-s</code>: elimina (strips) los símbolos de depuración.</p><p><code>---noexecstack</code>: marca la memoria escribible como no ejecutable (DEP)</p><p>Se pueden revisar opciones de seguridad de los binarios usando:</p><pre tabindex=0><code>checksec --file=${EJECUTABLE}
checksec --directory=${EJECUTABLE}
</code></pre><p><a href=https://wiki.debian.org/Hardening target=_blank rel=noopener>Guía de Debian para proteger los programas</a>.</p><h2 id=cómo-demostrar-programas-vulnerables><a href=#c%c3%b3mo-demostrar-programas-vulnerables alt>Cómo demostrar programas vulnerables</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Para aprender los básicos acerca de cómo atacar programas,
conviene <a href=https://stackoverflow.com/questions/2340259/how-to-turn-off-gcc-compiler-optimization-to-enable-buffer-overflow target=_blank rel=noopener>deshabilitar las funciones de seguridad en la compilación de los programas</a>,
<a href=https://reverseengineering.stackexchange.com/a/27682 target=_blank rel=noopener>incluyendo RELRO</a>.</p><pre tabindex=0><code>gcc \
    -fno-stack-protector \
    -no-pie \
    -Wl,-z,norelro,execstack \
    -o ${PROGRAM} \
    ${SOURCE}
</code></pre><p>En varios sitios recomiendan además <a href=https://0x10f8.wordpress.com/2019/05/21/subverting-nx-bit-with-return-to-libc/ target=_blank rel=noopener>desactivar ASLR en la configuración del kernel</a>:</p><pre tabindex=0><code># echo 0 &gt; /proc/sys/kernel/randomize_va_space
</code></pre><p>Sobrescribir la pila,
permite controlar el flujo de ejecución del programa
porque <a href=http://theamazingking.com/tut2.php target=_blank rel=noopener>en la pila se guardan los punteros para continuar la ejecución del programa</a>.</p><h2 id=ejecutar-programas-desde-la-pila><a href=#ejecutar-programas-desde-la-pila alt>Ejecutar programas desde la pila</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>En la mayoría de los casos los sistemas operativos actualizados
impiden la ejecución de código en la pila
aunque <a href=https://stackoverflow.com/a/3756315/10467443 target=_blank rel=noopener>es posible que algunos dispositivos embebidos aún contengan esta vulnerabilidad</a></p><p><a href=https://stackoverflow.com/a/3755573/10467443 target=_blank rel=noopener>Esta respuesta de Stack Overflow</a>
lista algunos punteros para desactivar las protecciones:</p><blockquote><p>&ldquo;- Disable stack protection at the OS level.</p><ul><li>Allow execution from the stack on a particular executable file.</li><li>mprotect() the stack.</li><li>Maybe some other things&mldr;&rdquo;</li></ul></blockquote><p>Esta medida de seguridad es difícil de desactivar
porque <a href=https://security.stackexchange.com/a/230816/274242 target=_blank rel=noopener>se tiene que desactivar en todo el sistema operativo
y no puede desactivarse únicamente para un programa
o dentro de un contenedor</a>.</p><p>Por lo tanto, para montar estos juegos,
estoy considerando usar alguna máquina virtual ultra ligera:</p><ul><li><p>Alpine sobre <code>QEMU</code>:</p><p>Sospecho que esta va a ser la forma más sencilla de levantar un servicio
que tenga desactivado ASLR.</p></li><li><p><a href=https://github.com/miklevin/Levinux title="Sistema operativo que se ejecuta en RAM y tiene mensajes para aprendizaje" target=_blank rel=noopener>Levinux</a>:</p><p>Me llamó la atención porque
funciona en los 3 sistemas operativos mayoritarios
tiene un perspectiva educativa
y al parecer algunos tutoriales.
<a href=https://web.archive.org/web/20220518140233/https://mikelev.in/2011/08/virtual-machine-runs-anywhere/ title="Aunque probablemente use alpine sobre QEMU de todas formas." target=_blank rel=noopener>Aquí está un post acerca de cómo se hizo Levinux</a>.
Al final es un <code>QEMU</code>.</p></li></ul><h2 id=cómo-aprovechar-la-vulnerabilidad-de-los-programas-para-ejecutar-código-arbitrario><a href=#c%c3%b3mo-aprovechar-la-vulnerabilidad-de-los-programas-para-ejecutar-c%c3%b3digo-arbitrario alt>Cómo aprovechar la vulnerabilidad de los programas para ejecutar código arbitrario</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Si tienes suficiente espacio en un programa vulnerable,
puedes escribir una función arbitraria en la memoria del programa.</p><p>Hay <a href=http://shell-storm.org/shellcode/ target=_blank rel=noopener>inventarios de funciones en ensamblador para ataques de overflow</a></p><p>En caso contrario, <a href=https://insecure.org/stf/smashstack.html target=_blank rel=noopener>puedes escribir el código en el entorno
y apuntar el puntero de retorno a tu código</a>.</p><h2 id=cómo-atacar-la-memoria-cuándo-está-protegida><a href=#c%c3%b3mo-atacar-la-memoria-cu%c3%a1ndo-est%c3%a1-protegida alt>Cómo atacar la memoria cuándo está protegida</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Se puede utilizar el código que ya está en memoria para construir programas arbitrarios,
eso se conoce como <a href=https://en.wikipedia.org/wiki/Return-oriented_programming target=_blank rel=noopener>return-oriented programming (ROP)</a>
y <a href=https://seclists.org/bugtraq/1997/Aug/63 target=_blank rel=noopener>este es uno de los primeros ejemplos</a>.</p><p><a href=http://shell-storm.org/talks/ROP_course_lecture_jonathan_salwan_2014.pdf target=_blank rel=noopener>Se pueden generar ataques elaborados con las instrucciones en memoria</a>.</p><p><a href=https://github.com/JonathanSalwan/ROPgadget/tree/master target=_blank rel=noopener>Esta herramienta busca código disponible para construir tus programas</a>.</p><h2 id=cómo-evitar-que-se-diagnostiquen-los-programas><a href=#c%c3%b3mo-evitar-que-se-diagnostiquen-los-programas alt>Cómo evitar que se diagnostiquen los programas</a> <a href=# alt="Regresar al inicio">↑</a></h2><p><a href=http://shell-storm.org/blog/Linux-process-execution-and-the-useless-ELF-header-fields/ target=_blank rel=noopener>Eliminar los campos de ELF que no se usan para ejecutar impide su depuración</a>
y <a href=http://shell-storm.org/blog/Linux-process-execution-and-the-useless-ELF-header-fields/anti-debug.c target=_blank rel=noopener>aquí hay código para hacerlo</a>.</p><p>También <a href=http://shell-storm.org/blog/Polymorphism-and-Return-Oriented-Programming/ target=_blank rel=noopener>se puede alterar un programa por otro funcionalmente equivalente
que no contenga la parte común de los exploits</a>.</p><p><a href=https://stackoverflow.com/questions/5752605/tool-to-clearly-visualize-memory-layout-of-a-c-program target=_blank rel=noopener>Herramientas para visualizar la memoria</a>:</p><ul><li><a href=https://www.cs.kent.ac.uk/projects/gc/gcspy/ target=_blank rel=noopener>GCspy</a></li><li><a href=http://www.cs.kent.edu/~jmaletic/cs69995-PC/papers/Moreta07.pdf target=_blank rel=noopener>Paper de visualización donde no se muestra ni se hace referencia al código</a></li></ul><h2 id=herramientas-para-programar-con-código-existente><a href=#herramientas-para-programar-con-c%c3%b3digo-existente alt>Herramientas para programar con código existente</a> <a href=# alt="Regresar al inicio">↑</a></h2><p><a href=https://triton.quarkslab.com/ target=_blank rel=noopener>Análisis dinámico de binarios</a></p><p><a href=http://shell-storm.org/project/ROPgadget/ target=_blank rel=noopener>http://shell-storm.org/project/ROPgadget/</a></p><p>La idea es usar código que contiene funciones que retornan,
porque se pueden encadenar para alcanzar cualquier objetivo.</p><p>Esto se conoce como <strong>Return Oriented Programming</strong>.
Tiene las ventajas de que se salta todas las protecciones conocidas de la pila
y puede mitigarse <a href=https://lwn.net/Articles/870045/ target=_blank rel=noopener>borrando los registros antes de retornar</a>,
<a href=https://www.jerkeby.se/newsletter/posts/rop-reduction-zero-call-user-regs/ target=_blank rel=noopener>introduciendo 13% JOP gadgets y reduciendo 36% ROP gadgets para Linux</a>.</p><p>Sin embargo, <a href=https://dustri.org/b/paper-notes-clean-the-scratch-registers-a-way-to-mitigate-return-oriented-programming-attacks.html target=_blank rel=noopener>borrar los registros podría deteriorar el rendimiento</a>
presumiblemente sin agregar a la seguridad.</p><p><a href=https://www.jerkeby.se/newsletter/posts/history-of-rop/ target=_blank rel=noopener>https://www.jerkeby.se/newsletter/posts/history-of-rop/</a></p><p><a href=https://stackoverflow.com/questions/1345670/stack-smashing-detected#comment37057047_1347464 target=_blank rel=noopener>Un consejo terrible: desactivar la protección anti pila en producción</a>.</p><h2 id=minimizar-el-tamaño-de-los-ctf><a href=#minimizar-el-tama%c3%b1o-de-los-ctf alt>Minimizar el tamaño de los CTF</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Las imágenes que <code>ctfcli</code> genera por defecto
son del orden de cientos de megabytes.</p><p>Aunque el espacio en disco es actualmente lo más barato en cómputo
y en varios lugares es gratuito tener varios GB de datos.</p><p>Sin embargo, para probar pequeños cambios en los juegos en un servidor,
tener que enviar cientos de MB por una pequeña diferencia no hace sentido
y toma mucho más tiempo hacer la retroalimentación y el diagnóstico.</p><p>Así que pensé en hacer imágenes mínimas
que contengan únicamente lo necesario para ejecutar el reto.
En algunos casos, sólo se necesita en el contenedor
los programas vulnerables compilados estáticamente
y <a href=https://skarnet.org/software/s6 target=_blank rel=noopener>la suite de supervisión</a>.</p><p>Una manera sencilla de hacer esto es compilar los programas
y luego generar un contenedor vacío que incluye:</p><ul><li>los programa necesarios</li><li>las bibliotecas que utilizan</li></ul><p>El <code>Dockerfile</code> quedaría parecido a:</p><pre tabindex=0><code>FROM debian:stretch-20211011-slim as builder

WORKDIR /root

RUN apt-get update \
  &amp;&amp; apt-get -y install \
    build-essential \
  &amp;&amp; apt clean

COPY src/makefile src/game.c /root/
RUN make game

FROM alpine:3.14.2 as system

RUN apk add \
        s6-networking \
        util-linux

WORKDIR /opt

COPY --from=builder /root/game /opt/app

FROM scratch

COPY --from=system \
  /lib/ld-musl-x86_64.so.1 \
  /lib/libskarnet.so.2.10 \
  /lib/libsmartcols.so.1 \
/lib/

COPY --from=system \
  /bin/s6-applyuidgid \
  /opt/app \
  /usr/bin/s6-tcpserver \
  /usr/bin/s6-tcpserver4d \
  /usr/bin/s6-tcpserver4-socketbinder \
  /usr/bin/prlimit \
/bin/

COPY --from=builder src/game /bin/app

EXPOSE 1337

CMD [&#34;/bin/s6-tcpserver&#34;, &#34;-u&#34;, &#34;1001&#34;, &#34;-g&#34;, &#34;1001&#34;, &#34;0.0.0.0&#34;, &#34;1337&#34;, &#34;/bin/prlimit&#34;, &#34;-t=3&#34;, &#34;/bin/app&#34;]
</code></pre><p>En algunas ocasiones,
el ejercicio requiere que sea posible ejecutar una consola,
por lo que podría convenir incluir en el contenedor
<a href=https://github.com/robxu9/bash-static/ target=_blank rel=noopener>una versión estática de bash</a>
como <code>/bin/sh</code>.</p><p>Se está trabajando además en una máquina virtual mínima,
y un sistema para reproducirlo.</p><h1 id=implementación-de-infraestructura-para-proyecto><a href=#implementaci%c3%b3n-de-infraestructura-para-proyecto alt>Implementación de infraestructura para proyecto</a> <a href=# alt="Regresar al inicio">↑</a></h1><h2 id=restringir-permisos-de-usuario-compartido-en-servidor><a href=#restringir-permisos-de-usuario-compartido-en-servidor alt>Restringir permisos de usuario compartido en servidor</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Esta configuración se está llevando a cabo en el directorio
${HOME}/src/gitlab.com/gcd-ibero/gestion-de-infraestructura
y se puede acceder a él con el comando <code>cd $(repo -inf)</code>.</p><ul><li><p>[✓] Utilizar un usuario compartido en un servidor
para que los estudiantes usen su propia compu para ejecutar los comandos.</p><ul><li>[✓] Generar el usuario.</li><li>[✓] Instalar <code>byobu</code>.</li><li>[✓] Generar una contraseña para el usuario</li></ul></li><li><p>[✓] Restringir los comandos que puede utilizar el usuario compartido:</p><p><a href=https://www.ibm.com/support/pages/how-use-restricted-shell title="Cómo usar una consola restringida" target=_blank rel=noopener>Cómo usar</a>
una <a href=https://www.gnu.org/software/bash/manual/html_node/The-Restricted-Shell.html target=_blank rel=noopener>consola restringida</a></p><ul><li><p>[✓] Asignar <code>rbash</code> como consola.</p></li><li><p>[✓] Generar un perfil que no puede modificarse y contiene las variables:</p><ul><li>[✓] <code>PATH</code></li></ul></li><li><p>[✓] Agregar al directorio configurado en el <code>PATH</code> los comandos:</p><ul><li>[✓] <code>ssh</code> para entrar al servidor de juegos</li><li>[✓] <code>man</code> para consultar documentación</li><li>[✓] <code>apropos</code> para consultar documentación</li><li>[✓] <code>info</code> para consultar documentación</li><li>[✓] <code>byobu</code> para compartir la pantalla</li><li>[✓] <code>less</code></li><li>[✓] <code>nano</code></li><li>[✓] <code>clear</code></li><li>[✓] <code>tput</code></li></ul></li><li><p>[✓] <a href=https://bryan-murdock.blogspot.com/2010/10/how-to-disable-ubuntu-command-not-found.html target=_blank rel=noopener>Desactivar el aviso de commando no encontrado</a></p><pre tabindex=0><code>unset command_not_found_handle
</code></pre></li></ul></li></ul><h2 id=generar-sitio-privado-para-documentación-de-estudiantes><a href=#generar-sitio-privado-para-documentaci%c3%b3n-de-estudiantes alt>Generar sitio privado para documentación de estudiantes</a> <a href=# alt="Regresar al inicio">↑</a></h2><p><code>cd $(repo -inf)/colaborative-writing</code></p><p>HedgeDoc les gustó mucho a los estudiantes del taller.</p><ul><li><p>[✓] Generar un <code>docker-compose.yml</code> con la configuración de
<a href=https://unix.stackexchange.com/questions/518849/how-does-one-set-up-codimd-as-a-personal-wiki target=_blank rel=noopener>CodiMD</a> o
<a href=https://docs.hedgedoc.org/setup/docker/ target=_blank rel=noopener>HedgeDoc</a></p></li><li><p>[✓] Configurar la instancia de <code>HedgeDoc</code> para ser privada.</p><p>¿Se puede autenticar?
<a href=https://docs.hedgedoc.org/guides/reverse-proxy/ target=_blank rel=noopener>usando un proxy inverso</a></p><p>Se utilizó <a href=https://docs.hedgedoc.org/configuration/ target=_blank rel=noopener>la documentación</a>
para <a href=/home/x/src/gitlab.com/gcd-ibero/gestion-de-infraestructura/colaborative-writing title="commit 1078c0">configurar la aplicación para ser privada</a>.</p><p>Se puede agregar la opción de autorizar con:
<a href=https://docs.hedgedoc.org/guides/auth/oauth/ target=_blank rel=noopener>OAuth</a>
<a href=https://docs.hedgedoc.org/guides/auth/ldap-ad/ target=_blank rel=noopener>LDAP</a></p><p><a href=https://github.com/geerlingguy/ansible-role-certbot target=_blank rel=noopener>Se puede configurar la auto-generación de certificados con Ansible</a></p></li><li><p>[✓] Configurar un proxy para que la instancia de <code>HedgeDoc</code> funcione desde un servidor remoto.</p><ul><li>Se modificaron las variables <code>CMD_DOMAIN</code> y <code>CMD_URL_ADDPORT</code>.</li></ul></li><li><p>[✓] Agregar un proxy <code>nginx</code> (/ge c74c771)</p></li><li><p>[✗] Configurar <code>certbot</code> para adquirir un certificado SSL para <code>pad.haase.mx</code>.
Usando <code>pad.lbustio.com</code> el sistema funcionó correctamente.</p><ul><li><p>[✓] El proxy de <code>nginx</code> debe
<a href=https://docs.hedgedoc.org/guides/reverse-proxy/ target=_blank rel=noopener>generar ciertos encabezados para funcionar apropiadamente</a>
(/ge 100c31a)</p></li><li><p>[✗] Generar un contenedor <code>certbot</code>
y compartir la configuración de certificados
para que <code>nginx</code> use los certificados.</p></li></ul></li><li><p>[✓] Configurar nuestro proxy de nginx
para redirigir el tráfico de <code>pad.lbustio.com</code>
desde <code>traefik</code> hacia nuestro proxy.</p><p><a href=https://doc.traefik.io/traefik/getting-started/configuration-overview/ target=_blank rel=noopener>https://doc.traefik.io/traefik/getting-started/configuration-overview/</a>
<a href=https://www.digitalocean.com/community/tutorials/how-to-use-traefik-as-a-reverse-proxy-for-docker-containers-on-ubuntu-18-04 target=_blank rel=noopener>https://www.digitalocean.com/community/tutorials/how-to-use-traefik-as-a-reverse-proxy-for-docker-containers-on-ubuntu-18-04</a></p><p><a href=https://www.digitalocean.com/community/tutorials/how-to-use-traefik-v2-as-a-reverse-proxy-for-docker-containers-on-ubuntu-20-04 target=_blank rel=noopener>https://www.digitalocean.com/community/tutorials/how-to-use-traefik-v2-as-a-reverse-proxy-for-docker-containers-on-ubuntu-20-04</a></p><pre tabindex=0><code>$ cr /ge
$ cd escritura-colaborativa
$ docker-compose --context=lbustio up -d
</code></pre><pre tabindex=0><code>$ cr /ge
$ mk pad
</code></pre><pre tabindex=0><code>$ docker-compose --context=lbustio logs proxy
Attaching to escritura-colaborativa_proxy_1
proxy_1  | /docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
proxy_1  | /docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/
proxy_1  | /docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
proxy_1  | 10-listen-on-ipv6-by-default.sh: info: can not modify /etc/nginx/conf.d/default.conf (read-only file system?)
proxy_1  | /docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh
proxy_1  | /docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh
proxy_1  | /docker-entrypoint.sh: Configuration complete; ready for start up
proxy_1  | 2021/08/13 22:26:17 [emerg] 1#1: unknown &#34;connection_upgrade&#34; variable
proxy_1  | nginx: [emerg] unknown &#34;connection_upgrade&#34; variable
</code></pre><p>-> Desafortunadamente, el proxy no está dirigiendo las aplicaciones como debe.</p><ul><li><p>🗵 Configurar <code>traefik</code> localmente.</p><p>No será necesario jugar por el momento,
porque el sistema reconoció <code>pad.lbustio.com</code></p></li></ul></li><li><p>☑ Agregar <code>pad.lbustio.com</code> al DNS.</p><p>Se le comunicó a Lázaro que hay que actualizar el DNS.</p><p>En <code>name.com</code> con el usuario lbustio.</p></li><li><p>☐ (Opcional) Automatizar que al final de la sesión de <code>HedgeDoc</code> se agreguen a una página.</p><p>Podría usarse <a href=https://github.com/hedgedoc/cli target=_blank rel=noopener>hedgedoc/cli</a></p></li><li><p>[?] Configurar el aviso para que cambien de teclado y dirección.</p><ul><li><p><a href=https://www.systutorials.com/docs/linux/man/1-byobu/ target=_blank rel=noopener>Se pueden agregar scripts en <code>$BYOBU_CONFIG_DIR/bin/${WAIT_TIME_IN_SECONDS}_${SCRIPT_NAME}</code></a>
para que actualice el usuario al teclado y el usuario dirigiendo cada 3 minutos,
con un aviso visual o auditivo muy evidente.</p></li><li><p>[?] Hacer que inicien sesión con su nombre.
Asociar su clave pública con el nombre en byobu.</p></li><li><p>[✗] Entrar a la sesión restringida de <code>byobu</code>.</p><p>La sesión no restringida de byobu nos está funcionando relativamente bien.</p></li></ul></li><li><p>[✓] Levantar aplicación <code>HedgeDoc</code> en &lt;pad.lbustio.com></p></li><li><p>☑ Agregar usuarios en HedgeDoc.</p><p>Podrían agregarse localmente los usuarios en HedgeDoc,
pero también podría intentarse generar un SingleSignOn
con el siguiente rubro, usando <code>authelia</code>.</p><ul><li><p>Podría hacerse desde la interfaz de HedgeDoc.</p><pre tabindex=0><code>ssh lb
USER=
docker exec -ti escritura-colaborativa-app-1 bash
/hedgedoc/bin/manage_users --add ${USER}
</code></pre></li><li><p>Podría agregarse un proxy de identidad
como <a href=https://github.com/authelia/authelia/ target=_blank rel=noopener>authelia</a>.</p></li><li><p>Podría solicitar que usen una cuenta de GitLab
y utilizar el servidor de autenticación de GitLab.</p></li></ul></li><li><p>☑ Agregar autenticación para acceder a la página de datos de servidor.</p><p><a href=https://mindup.medium.com/add-basic-authentication-in-docker-compose-files-with-traefik-34c781234970 target=_blank rel=noopener>Una posible opción para resolver este problema es usar <code>traefik</code></a></p><p>Parece que Renier intentó instalar authelia, pero no levanta.</p><p>${HOME}/xihh/proyectos/autenticación-de-lbustio.com</p></li><li><p>☑ Configurar <code>traefik</code> para reenviar los encabezados de la petición completos a hedgedoc.</p></li><li><p>☑ Grabar la sesión del taller para que la vean si faltan.</p></li><li><p>[?] <a href=https://docs.hedgedoc.org/guides/providing-terms/ target=_blank rel=noopener>Podría haber términos de uso en el pad</a>.</p></li></ul><h1 id=compartir-un-navegador-para-hacer-los-retos><a href=#compartir-un-navegador-para-hacer-los-retos alt>Compartir un navegador para hacer los retos</a> <a href=# alt="Regresar al inicio">↑</a></h1><p>Se generó un contendor con un sistema operativo especializado en ciberseguridad,
que contiene las aplicacione necesarias para explorar los juegos que se proponen
y que permite compartir el control de la máquina para trabajar en equipo.</p><h1 id=usar-servidor-para-prácticas-de-seguridad-informática><a href=#usar-servidor-para-pr%c3%a1cticas-de-seguridad-inform%c3%a1tica alt>Usar servidor para prácticas de seguridad informática</a> <a href=# alt="Regresar al inicio">↑</a></h1><p>Se generó un servidor que permite entregar la solución de los retos
en un medio competitivo.</p><p>Este servidor también permite mostrar los retos en el orden apropiado
y vincular los conocimientos con los retos.</p><h2 id=generar-sitio-de-documentación-para-taller-de-ciberseguridad><a href=#generar-sitio-de-documentaci%c3%b3n-para-taller-de-ciberseguridad alt>Generar sitio de documentación para taller de ciberseguridad</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Una de las técnicas de metacognición que trabajamos durante el taller
consiste en generar un plan de trabajo para solucionar cada uno de los juegos,
donde se identifican:</p><ul><li>Objetivo</li><li>Pasos a seguir</li><li>Incógnitas</li></ul><p>Esa herramienta se utiliza además para:</p><ul><li><p>Describir lo que se aprende en el camino,
haciendo explícito el conocimiento y ayudando a consolidarlo.</p></li><li><p>Retomar la actividad pasado un tiempo.</p></li><li><p>Introduciendo a los integrantes nuevos del equipo.</p></li></ul><h2 id=-cómo-compartir-control-en-aplicaciones-gráficas><a href=#-c%c3%b3mo-compartir-control-en-aplicaciones-gr%c3%a1ficas alt>☑ Cómo compartir control en aplicaciones gráficas</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Compartir la pantalla puede hacerse con:</p><ul><li><p>VNC server/viewer</p><ul><li><p><a href=https://www.realvnc.com/en/connect/download/vnc/ target=_blank rel=noopener>Real VNC</a> (propietario)</p></li><li><p>vinagre/vino</p></li><li><p>tigervnc</p></li><li><p>wayvnc</p></li><li><p>x11vnc</p></li></ul></li><li><p><a href=http://xpra.org/ target=_blank rel=noopener>Xpra</a></p><ul><li>se puede consultar directamente desde el navegador <a href=https://github.com/Xpra-org/xpra-html5 target=_blank rel=noopener>tiene un cliente HTML5</a></li><li><a href=https://github.com/Xpra-org/xpra/blob/master/README.md target=_blank rel=noopener>funciona en cualquier plataforma</a>.</li></ul><p>Se puede iniciar desde el servidor:</p><pre tabindex=0><code>MMAP=/run/user/1000/xpra/desktop.mmap
mkdir -p ${MMAP}
PROGRAM=dwm
xpra start-desktop --max-size=1024x768 --min-size=1024x768 --desktop-scaling=off --clipboard=yes --clipboard-direction=both --mmap=${MMAP} --start ${PROGRAM}
</code></pre><p>También se puede iniciar de manera remota</p><pre tabindex=0><code>USER=cybersecurity
SERVER=192.168.90.11
PROGRAM=dwm
xpra start-desktop --max-size=1024x768 --min-size=1024x768 --desktop-scaling=off --clipboard=yes --clipboard-direction=both ssh://${USER}@${SERVER}/ --start ${PROGRAM}
</code></pre><p>Para usar la gui compartida:</p><pre tabindex=0><code>MMAP=/run/user/1000/xpra/desktop.mmap
USER=
SERVER=192.168.122.120
REMOTE_DISPLAY=
xpra attach ssh://${SERVER}/${REMOTE_DISPLAY} --sharing=yes --start=firefox --clipboard=yes --clipboard-direction=both --max-size=1024x768 --min-size=1024x768 --mmap=${MMAP} # no funciona
</code></pre><p>Para iniciar aplicaciones:</p><pre tabindex=0><code>APP=
USER=
SERVER=192.168.122.120
REMOTE_DISPLAY=
xpra attach --desktop-scaling=off --sharing=yes --max-size=1024x768 --min-size=1024x768 --clipboard=yes --clipboard-direction=both --start-child ${APP} ssh://${USER}@${SERVER}/${REMOTE_DISPLAY}
</code></pre><h2 id=problemas-con-xpra><a href=#problemas-con-xpra alt>Problemas con xpra</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Si se usan las configuraciones de ssh, la conexión falla con el error:</p><pre tabindex=0><code>Warning: failed to connect:
 connection failed: &#39;canonicaldomains&#39;
</code></pre><p>Los menúes de las GUIs no permanecen abiertos como en las aplicaciones locales</p></li></ul><ul><li><p>☐ Configurar un servicio en el servidor que pueda compartirse.</p><p><code>cr lb</code> (commit 4a717c)</p></li><li><p>☑ Configurar un servicio en el servidor que pueda usar ssh desde red inalámbrica en ibero.</p><p>Configurando un proxy TCP para el servidor SSH.</p></li><li><p>[?] Configurar monitoreo para redes:</p></li></ul><h2 id=herramientas-para-visualizar-la-memoria-urlhttpsstackoverflowcomquestions5752605tool-to-clearly-visualize-memory-layout-of-a-c-program><a href=#herramientas-para-visualizar-la-memoria-urlhttpsstackoverflowcomquestions5752605tool-to-clearly-visualize-memory-layout-of-a-c-program alt>Herramientas para visualizar la memoria [@url:https://stackoverflow.com/questions/5752605/tool-to-clearly-visualize-memory-layout-of-a-c-program]</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Dado que una de las regiones más desarrollada de nuestro cerebro es el córtex visual,
los mecanismos de visualización nos permiten comunicarnos efectivamente
y transmitir ideas complejas muy rápidamente
cuando se utilizan representaciones visuales efectivas.</p><p>Muchos de los programas que se usan en el área de ciberseguridad
muestran una representación textual de la memoria
y de las instrucciones de los programas ejecutables.</p><p>Una de las limitantes para entender qué estamos haciendo
al desarrollar estas habilidades,
es que la abstracción necesaria para explorar las aplicaciones
usando herramientas con representación textual
no facilita la introducción a estas actividades.</p><ul><li><p><a href=https://www.cs.kent.ac.uk/projects/gc/gcspy/ target=_blank rel=noopener>GCspy</a></p></li><li><p><a href=http://www.cs.kent.edu/~jmaletic/cs69995-PC/papers/Moreta07.pdf target=_blank rel=noopener>Paper de visualización donde no se muestra ni se hace referencia al código</a></p></li><li><p><a href=https://qira.me/ target=_blank rel=noopener>QIRA</a></p></li><li><p><a href=https://github.com/longld/peda target=_blank rel=noopener>PEDA</a></p></li><li><p><a href=https://cutter.re/ target=_blank rel=noopener>Cutter</a></p><ul><li><p><a href=https://github.com/radareorg/iaito target=_blank rel=noopener>iaito</a></p></li><li><p><a href=https://github.com/radareorg/radare2 target=_blank rel=noopener>radare2</a></p></li><li><p><a href=https://rizin.re/ target=_blank rel=noopener>rizin</a></p></li></ul></li><li><p><a href=https://github.com/joyent/statemap target=_blank rel=noopener>statemap</a>
y <a href='https://www.youtube.com/watch?v=x3rmg33j7RA' target=_blank rel=noopener>el video con el que lo encontré</a></p><p>(parece que statemap requiere input de «instrumentation»)</p></li></ul><p><a href=https://www.ubuntupit.com/best-linux-debuggers-for-modern-software-engineers/ target=_blank rel=noopener>Varios debuggers permiten visualizar la memoria</a>:</p><ul><li><code>ddd</code></li><li><code>kgdb</code></li><li><code>ghidra</code></li><li><code>affinic-debugger</code></li></ul><p><a href=https://stackoverflow.com/questions/5344764/gui-debugger-for-c-on-linux target=_blank rel=noopener>https://stackoverflow.com/questions/5344764/gui-debugger-for-c-on-linux</a>:</p><ul><li><p><code>nemiver</code></p></li><li><p><a href=https://github.com/DataChi/memdb target=_blank rel=noopener>https://github.com/DataChi/memdb</a></p></li><li><p><a href=https://www.xmodulo.com/visualize-memory-usage-linux.html target=_blank rel=noopener>https://www.xmodulo.com/visualize-memory-usage-linux.html</a></p></li></ul><p><a href=https://github.com/eteran/edb-debugger target=_blank rel=noopener><code>edg</code> está inspirado en Ollydbg</a>
y tiene <a href=https://github.com/eteran/edb-debugger/wiki/Stack-View target=_blank rel=noopener>un widget para visualizar el stack <code>Stack View</code></a>.</p><h2 id=dirigir-el-entrenamiento-hacia-binarios-y-cómo-funcionan-las-computadoras><a href=#dirigir-el-entrenamiento-hacia-binarios-y-c%c3%b3mo-funcionan-las-computadoras alt>Dirigir el entrenamiento hacia binarios y cómo funcionan las computadoras</a> <a href=# alt="Regresar al inicio">↑</a></h2><ul><li><p>Ética</p><ul><li>Legislación</li><li>Responsible Disclosure</li><li>Bug Bounties</li></ul></li><li><p>Ejercicios de ASM</p></li><li><p>Errores comunes en programas de C sin mitigaciones</p><ul><li>Stack Overflow</li><li>Heap Overflow</li><li>Use after free</li><li>Format String Vulnerability</li></ul></li><li><p>Ejecución con bibliotecas dinámicas</p><p><a href=https://blog.gibson.sh/2017/11/26/creating-portable-linux-binaries/ target=_blank rel=noopener>Un artículo que explica cómo usar versiones portables de las bibliotecas</a></p><p><a href=https://github.com/georgy7/build-with-musl target=_blank rel=noopener>Un tutorial para construir programas vinculados estáticamente</a></p><p><a href=https://github.com/robxu9/bash-static/blob/master/build.sh target=_blank rel=noopener>Un script para construir bash estáticamente</a></p></li><li><p>Derrotar mitigaciones:</p><ul><li><p>ALSR</p><ul><li>Hacer que el programa te diga el lugar de la memoria
donde se cargan las funciones de la tabla global de ajustes (GOT).</li></ul></li><li><p>NX</p><ul><li>Escribir en la pila únicamente las direccioens del código que quieres ejecutar.</li></ul></li><li><p>Stack Canary</p><ul><li><p>Hacer que el programa te diga el código secreto.</p><p>¿Sobreescribir cuidando mantener este código secreto?</p></li></ul></li><li><p><a href=https://googleprojectzero.blogspot.com/2019/02/examining-pointer-authentication-on.html target=_blank rel=noopener>Pointer Autentication</a></p><ul><li>¿Fuerza bruta?</li></ul></li></ul></li><li><p>Encontrar problemas en software</p><ul><li>Fuzzers</li></ul></li><li><p>Return Oriented Programming</p><ul><li>Escribir en la pila los lugares donde está el código que quieres ejecutar.</li></ul></li><li><p>Otros lenguajes de programación</p><ul><li>eval</li></ul></li><li><p>HTTP session hijacking</p></li><li><p><a href=https://www.redeszone.net/tutoriales/seguridad/que-son-ataques-inyeccion-comandos/ target=_blank rel=noopener>Inyección de comandos</a></p><ul><li>SQL injection</li></ul></li><li><p>Cross Site Scripting (XSS)</p><ul><li>sandbox iframes</li></ul></li><li><p>Server Side Request Forgery</p></li><li><p>WEP/WPA cracking</p></li><li><p><strong>Explorar bug bounties</strong></p></li></ul></article></main></body></html>