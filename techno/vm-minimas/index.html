<!doctype html><html lang=es-mx><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Máquinas virtuales mínimas</title><link rel=stylesheet media=screen href=https://joshua.haase.mx/css/theme.min.2ee1317322f9eb9b2ef0a618d19b20e38c11f5f9c310751400a45db225dd2626.css integrity="sha256-LuExcyL565su8KYY0Zsg44wR9fnDEHUUAKRdsiXdJiY="><script src=https://hypothes.is/embed.js></script></head><body><main><article><h1>Máquinas virtuales mínimas</h1><nav id=TableOfContents><ul><li><a href=#plan>Plan</a></li><li><a href=#máquinas-virtuales-mínimas-y-reproducibles>Máquinas virtuales mínimas y reproducibles</a><ul><li><a href=#espacio-de-disco>Espacio de disco</a></li><li><a href=#ram>RAM</a></li><li><a href=#cpu-asignado>CPU asignado</a></li></ul></li><li><a href=#convertir-imágenes-de-virtualbox-a-qemukvm>Convertir imágenes de Virtualbox a QEMU/KVM</a></li><li><a href=#usar-contenedores-para-la-mayoría-de-los-retos>Usar contenedores para la mayoría de los retos</a></li><li><a href=#usar-máquinas-virtuales-para-retos-potencialmente-problemáticos>Usar máquinas virtuales para retos potencialmente problemáticos</a></li><li><a href=#user-mode-linux-uml>User Mode Linux (UML)</a></li><li><a href=#tinycore--levinux>TinyCore / Levinux</a><ul><li><a href=#para-usar-tinycore-desde-qemu>Para usar tinycore desde qemu</a></li><li><a href=#desactivar-alsr>Desactivar ALSR</a></li><li><a href=#ejecutar-como-usuario-sin-privilegios>Ejecutar como usuario sin privilegios</a></li><li><a href=#configurar-s6>Configurar s6</a></li><li><a href=#generar-un-paquete-para-tinycore>Generar un paquete para tinycore</a></li></ul></li><li><a href=#o-tal-vez-puedo-dar-personality-a-los-binarios>O tal vez puedo dar <code>personality</code> a los binarios</a></li></ul></nav><p>Haciendo <a href=../aplicaciones-vulnerables-para-poc/>retos para enseñar conceptos de ciberseguridad</a>
me encontré que no es suficiente generar contenedores con los servicios.</p><p>Varias de <a href=../aplicaciones-vulnerables-para-poc/#c%c3%b3mo-demostrar-programas-vulnerables>las protecciones anti-ataque se establecen a nivel de sistema operativo</a>
y no pienso desactivar las protecciones de seguridad en mi infraestructura.</p><p>Por lo tanto, la única vía de acción que queda es generar para los retos…</p><h2 id=plan><a href=#plan alt>Plan</a> <a href=# alt="Regresar al inicio">↑</a></h2><ul><li>[?] <del>configurar este sistema para iniciar con s6</del>.</li><li>[?] <del>Configurar ssh para usar una llave individual por persona,
ejecutando cada nivel con diferencias ligeras</del>.</li><li><input checked disabled type=checkbox> <a href=#desactivar-alsr>Desactivar ALSR para la máquina virtual en la configuración de <code>/etc/sysctl.d</code></a>.</li><li><input disabled type=checkbox> Configurar los servicios de los juegos y exponer el puerto,
usando un usuario por cada nivel.</li><li><input checked disabled type=checkbox> <a href=#ejecutar-como-usuario-sin-privilegios>Ejecutar el servicio de QEMU como un usuario sin privilegios</a>.</li></ul><h2 id=máquinas-virtuales-mínimas-y-reproducibles><a href=#m%c3%a1quinas-virtuales-m%c3%adnimas-y-reproducibles alt>Máquinas virtuales mínimas y reproducibles</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Hay herramientas bien probadas para generar y gestionar máquinas virtuales:</p><ul><li><p><a href=https://www.vagrantup.com/ target=_blank rel=noopener><code>vagrant</code></a>
puede usarse para configurar máquinas con vagrant.</p><p>Para gestionar las máquinas con vagrant,
necesitan un usuario <code>vagrant</code>
<a href=https://github.com/hashicorp/vagrant/tree/main/keys target=_blank rel=noopener>con estas llaves públicas</a> en <code>~/.ssh/authorized_keys</code>.</p></li><li><p><a href=https://www.packer.io/ target=_blank rel=noopener><code>packer</code></a>
<a href=https://www.packer.io/docs/templates/hcl_templates target=_blank rel=noopener>usa el mismo lenguaje de terraform</a>
para generar imágenes
<a href=https://www.packer.io/plugins/builders/qemu target=_blank rel=noopener>en muchos sistemas</a>.</p></li></ul><p>Para el caso de las máquinas para pruebas de concepto,
quisiera que las VM usen el mínimo posible de recursos,
dado que se utilizarán para concursos sencillos para CTF.</p><p><a href=http://oirase.annexia.org/tmp/paper.pdf target=_blank rel=noopener>Optimizando QEMU se podría iniciar en 600ms</a>,
<a href=http://oirase.annexia.org/tmp/paper.pdf target=_blank rel=noopener>el artículo</a> menciona que «Clear Containers demo»
es capaz de iniciar en 150ms y usa 20MB de RAM.
Y refiere a esta <a href=https://lwn.net/Articles/644675/ target=_blank rel=noopener>optimización de VM para iniciar linux</a>:
Usar <code>kvmtool</code> para iniciar directamente linux.</p><p><a href=https://thenewstack.io/securing-containers-intels-clear-containers/ target=_blank rel=noopener>Los «Contenedores Limpios de Intel» nacieron para mejorar la seguridad</a>,
durante el proyecto se desarrolló <a href=https://github.com/rkt/rkt target=_blank rel=noopener><code>rkt</code></a>
pero el desarrollo se canceló.
<a href='https://github.com/clearcontainers?q=clearconta&amp;type=all&amp;language=&amp;sort=' target=_blank rel=noopener>La página oficial de Clear Containers</a>
recomienda usar <a href=https://katacontainers.io/ target=_blank rel=noopener>Kata Containers</a>.</p><p>Los Contenedores Kata,
<a href=https://github.com/kata-containers/kata-containers/tree/main/docs/design/architecture target=_blank rel=noopener>son máquinas virtuales pequeñas que se comportan como contenedores</a>
y <a href=https://github.com/kata-containers/kata-containers/blob/main/docs/hypervisors.md target=_blank rel=noopener>pueden utilizar varios hipervisores</a> como motor.
(De entre los hipervisores soportados,
me pareció especialmente interesante <a href=https://projectacrn.org/ target=_blank rel=noopener>ACRN</a>
que sirve para dispositivos embebidos.)</p><p>Al parecer <a href=https://cloudnativetech.wordpress.com/2018/01/31/kata-containers-dev-environment-setup-with-vagrant/ target=_blank rel=noopener>se pueden generar <code>Contenedores Kata</code> con vagrant (virtualbox)</a>
usando el plugin <a href=https://github.com/coolsvap/vagrant-kata-dev target=_blank rel=noopener><code>vagrant-kata-dev</code></a>.</p><p>Para el caso de la máquina virtual del taller de ciberseguridad,
quisiera tener un <a href=https://app.vagrantup.com/kalilinux/boxes/rolling target=_blank rel=noopener>kalilinux</a> reproducible,
pero ejecutándose sobre QEMU/KVM.
A la fecha (2022-03-29), no he encontrado esta imagen.</p><h3 id=espacio-de-disco><a href=#espacio-de-disco alt>Espacio de disco</a> <a href=# alt="Regresar al inicio">↑</a></h3><p><del>Se puede compilar un núcleo en menos de 70MB,</del></p><p>La <a href=https://dl-cdn.alpinelinux.org/alpine/v3.16/releases/x86_64/alpine-virt-3.16.0-x86_64.iso target=_blank rel=noopener>imagen de alpine para virtualización</a> pesa ~70 MB
e incluye herramientas de espacio de usuario (busybox, tal vez algo más),
el <code>initrd</code>,
el gestor de paquetes
y configuraciones adicionales.</p><p>Así que 70MB de disco puede ser bastante razonable.</p><h3 id=ram><a href=#ram alt>RAM</a> <a href=# alt="Regresar al inicio">↑</a></h3><p>Si sólo vamos a cargar una aplicación que esperamos ocupe muy poca memoria,
podemos asignar 512K y tal vez debería funcionar razonablemente bien.</p><h3 id=cpu-asignado><a href=#cpu-asignado alt>CPU asignado</a> <a href=# alt="Regresar al inicio">↑</a></h3><p>QEMU tengo entendido sólo puede asignar 1 core mínimo,
pero tal vez podríamos allí correr todas las VM con esa necesidad.</p><p>Las desventajas podrían ser:</p><ul><li>que se rompieran al mismo tiempo todos los juegos.</li><li>que se peleen por los recursos.</li></ul><p>QEMU es un proceso y podría ser asignado como de baja prioridad.
Eso tal vez haría los juegos lentos (o no).</p><h2 id=convertir-imágenes-de-virtualbox-a-qemukvm><a href=#convertir-im%c3%a1genes-de-virtualbox-a-qemukvm alt>Convertir imágenes de Virtualbox a QEMU/KVM</a> <a href=# alt="Regresar al inicio">↑</a></h2><pre tabindex=0><code>qemu-img convert \
    -f vmdk \
    -O qcow2 \
    ${INPUT} \
    ${OUTPUT}
</code></pre><h2 id=usar-contenedores-para-la-mayoría-de-los-retos><a href=#usar-contenedores-para-la-mayor%c3%ada-de-los-retos alt>Usar contenedores para la mayoría de los retos</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Los juegos que se pueden ejecutar sin desactivar opciones de sistema operativo
pueden ejecutarse en un contenedor.</p><h2 id=usar-máquinas-virtuales-para-retos-potencialmente-problemáticos><a href=#usar-m%c3%a1quinas-virtuales-para-retos-potencialmente-problem%c3%a1ticos alt>Usar máquinas virtuales para retos potencialmente problemáticos</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Para los <a href=../retos-ctf/>juegos que deben desactivar las opciones de seguridad del sistema operativos</a>.</p><h2 id=user-mode-linux-uml><a href=#user-mode-linux-uml alt>User Mode Linux (UML)</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Se puede <a href=http://user-mode-linux.sourceforge.net/ target=_blank rel=noopener>utilizar un linux como un proceso</a>
y en principio estaría aislado del servidor
casi como una máquina virtual.</p><pre tabindex=0><code>paru -S linux-usermode uml_utilities
</code></pre><p><a href=https://www.landley.net/code/UML.html target=_blank rel=noopener>Rob Landley dice que es como tener un emulador</a>.
que <a href=http://user-mode-linux.sourceforge.net/old/UserModeLinux-HOWTO-1.html#ss1.4 target=_blank rel=noopener>tiene estas ventajas</a>.</p><p>Al parecer,
<a href=http://user-mode-linux.sourceforge.net/old/UserModeLinux-HOWTO-1.html#ss1.4 target=_blank rel=noopener>UML habla con el sistema operativo
en vez de hablar con el software</a>.</p><p>Se puede <a href=https://wiki.archlinux.org/title/User-mode_Linux target=_blank rel=noopener>instalar desde AUR</a>
y <a href=https://wiki.archlinux.org/title/User-mode_Linux#Setup_by_rootfs_+_tap target=_blank rel=noopener>configurar una red virtual exclusiva para los juegos</a>.</p><p>Para intercambiar archivos se recomienda usar <code>humfs</code>,
que es un sistema de archivos que utiliza un directorio para los archivos
y otro para los meta-datos [@isbn:978-0-13-186505-1, ch. 6].</p><h2 id=tinycore--levinux><a href=#tinycore--levinux alt>TinyCore / Levinux</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Durante 2024-04-11 revisé mi investigación
y encontré <a href=https://github.com/miklevin/levinux target=_blank rel=noopener>esta máquina virtual de 20MB</a>
(via <a href=https://www.youtube.com/user/miklevin target=_blank rel=noopener>miklevin</a>)
basada en <a href=http://www.tinycorelinux.net/ target=_blank rel=noopener>TinyCore</a>
(<a href=http://www.tinycorelinux.net/corebook.pdf target=_blank rel=noopener>libro</a>,
<a href=https://web.archive.org/web/20201112015615/http://distro.ibiblio.org/tinycorelinux/architecture.html target=_blank rel=noopener>diagrama</a>).</p><p>Hice el experimento y pude hacer que se ejecute desde el servidor:</p><pre tabindex=0><code>$ ssh h
$ cd ~/levinux-master/Levinux.app/Contents/MacOS
$ TERM=xterm ./qemu-system-i386 -curses -kernel vmlinuz -initrd core.gz -L ./ -hda opt.qcow -hdc tce.qcow -tftp ../../../Reset/Server -append &#34;loglevel=3 home=sda1 opt=sdb1 tce=sdc1&#34;
</code></pre><p>Dado que el sistema inicia correctamente y usa sólo 100MB de memoria,
que es demasiado pero puede ser aceptable porque tengo mucha memoria libre;
Para simplificar los juegos, podría:</p><h3 id=para-usar-tinycore-desde-qemu><a href=#para-usar-tinycore-desde-qemu alt>Para usar tinycore desde qemu</a> <a href=# alt="Regresar al inicio">↑</a></h3><p>Descargué la imagen de tinycore y tuve que modificarla para iniciar sobre la consola serial:</p><pre tabindex=0><code>$ mkdir ~/tinycore
$ fuseiso mount /path/to/tinicore.iso ~/tinycore
$ mkdir -p ~/coredir/core
$ cd coredir
$ cp ~/tinycore/boot/core.gz ~/tinycore/boot/vmlinuz .
# cd core
# bsdtar -xf ../core.gz
# nvim ./etc/inittab
</code></pre><p>Allí agregué la línea:</p><pre tabindex=0><code class=language-inittab data-lang=inittab>ttyS0::respawn:/sbin/getty -nl /sbin/autologin 38400 ttyS0
</code></pre><p>Y luego volví a comprimir la imagen para usar,
requiere superusuario porque varios archivos en la imagen son de root:</p><pre tabindex=0><code>$ cd ~/coredir/core
$ bsdtar -tf ~/tinycore/boot/core.gz \
  | sudo cpio -ovH newc &gt; ~/coredir/coremod
</code></pre><p>Ahora puedo iniciar el sistema:</p><pre tabindex=0><code>$ cd ~/coredir
$ qemu-system-x86_64 \
  -kernel ./vmlinuz \
  -initrd ./coremod \
  -append &#34;console=ttyS0&#34; \
  -nographic
</code></pre><h3 id=desactivar-alsr><a href=#desactivar-alsr alt>Desactivar ALSR</a> <a href=# alt="Regresar al inicio">↑</a></h3><p>Agregar a la configuración del kernel:</p><pre tabindex=0><code class=language-coredir/core/etc/sysctl.conf data-lang=coredir/core/etc/sysctl.conf>kernel.randomize_va_space = 0
</code></pre><p>Agregar la instrucción para usar esta configuración.</p><h3 id=ejecutar-como-usuario-sin-privilegios><a href=#ejecutar-como-usuario-sin-privilegios alt>Ejecutar como usuario sin privilegios</a> <a href=# alt="Regresar al inicio">↑</a></h3><pre tabindex=0><code>sudo -u nobody \
qemu-system-x86_64 \
    -kernel ./vmlinuz \
    -initrd ./coremod.gz \
    -append &#39;console=ttyS0&#39; \
    -nographic
</code></pre><h3 id=configurar-s6><a href=#configurar-s6 alt>Configurar s6</a> <a href=# alt="Regresar al inicio">↑</a></h3><p>Primero necesito instalar las bibliotecas, execline, s6 y s6-rc.</p><pre tabindex=0><code>./configure \
  --enable-slashpackage \
  --disable-allstatic \
  --enable-shared
make
sudo make install
sudo make -L global-links
</code></pre><p>Tuve este problema compilando</p><pre tabindex=0><code>tc@box:~/build/s6-rc-0.5.5.0$ make
exec gcc -D_POSIX_C_SOURCE=200809L -D_XOPEN_SOURCE=700 -iquote src/include-local -Isrc/include -fPIC -Werror=implicit-function-declaration -Werroc
exec gcc -o s6-rc-oneshot-run -pipe -Wall -std=c99 -fno-exceptions -fno-unwind-tables -fno-asynchronous-unwind-tables -ffunction-sections -fdata-
/usr/local/bin/ld: warning: libs6.so.2.13, needed by libs6rc.so.xyzzy, not found (try using -rpath or -rpath-link)
/usr/local/bin/ld: libs6rc.so.xyzzy: undefined reference to `s6_supervise_link&#39;
/usr/local/bin/ld: libs6rc.so.xyzzy: undefined reference to `s6_svc_writectl&#39;
/usr/local/bin/ld: libs6rc.so.xyzzy: undefined reference to `s6_supervise_unlink&#39;
/usr/local/bin/ld: libs6rc.so.xyzzy: undefined reference to `s6_svstatus_read&#39;
collect2: error: ld returned 1 exit status
make: *** [Makefile:137: s6-rc-oneshot-run] Error 1
</code></pre><h3 id=generar-un-paquete-para-tinycore><a href=#generar-un-paquete-para-tinycore alt>Generar un paquete para tinycore</a> <a href=# alt="Regresar al inicio">↑</a></h3><p>Una vez que instalé los paquetes comprimo los directorios en</p><pre tabindex=0><code># mksquashfs directorio [...otros directorios opcionalmente...] nombre-paquete.tcz
</code></pre><p>Para instalar en tinycore puedo descomprimirlo:</p><pre tabindex=0><code># squashfs -f -d /directory /path/to/s6.tcz
</code></pre><ul><li><a href='https://wiki.tinycorelinux.net/doku.php?id=wiki:extension_for_settings' target=_blank rel=noopener>Documentación para generar un paquete de tinycore</a></li><li><a href='https://forum.tinycorelinux.net/index.php?topic=2072.0' target=_blank rel=noopener>Foro con documentación para paquetes TCE</a></li></ul><h2 id=o-tal-vez-puedo-dar-personality-a-los-binarios><a href=#o-tal-vez-puedo-dar-personality-a-los-binarios alt>O tal vez puedo dar <code>personality</code> a los binarios</a> <a href=# alt="Regresar al inicio">↑</a></h2><p><a href=https://man7.org/linux/man-pages/man2/personality.2.html target=_blank rel=noopener>Manual de personality</a>,
posiblemente podría cambiar la seguridad con <code>ADDR_NO_RANDOMIZE</code>.</p></article></main></body></html>