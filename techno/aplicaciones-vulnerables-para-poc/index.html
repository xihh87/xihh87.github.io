<!doctype html><html lang=es-mx><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Generar aplicaciones vulnerables para prueba de concepto de exploits</title><link rel=stylesheet media=screen href=https://joshua.haase.mx/css/theme.min.c631e12f4e2b4b8b5282c3d94590678b7a225e8caccee02c0d37dac1838d6a61.css integrity="sha256-xjHhL04rS4tSgsPZRZBni3oiXoyszuAsDTfawYONamE="><script src=https://hypothes.is/embed.js></script></head><body><main><article><h1>Generar aplicaciones vulnerables para prueba de concepto de exploits</h1><nav id=TableOfContents><ul><li><a href=#cómo-se-protegen-los-programas>Cómo se protegen los programas</a></li><li><a href=#cómo-demostrar-programas-vulnerables>Cómo demostrar programas vulnerables</a></li><li><a href=#ejecutar-programas-desde-la-pila>Ejecutar programas desde la pila</a></li><li><a href=#cómo-aprovechar-la-vulnerabilidad-de-los-programas-para-ejecutar-código-arbitrario>Cómo aprovechar la vulnerabilidad de los programas para ejecutar código arbitrario</a></li><li><a href=#cómo-atacar-la-memoria-cuándo-está-protegida>Cómo atacar la memoria cuándo está protegida</a></li></ul></nav><p>La mayoría de las vulnerabilidades en los programas son errores de gestión de memoria.</p><p>Para enseñar cómo funcionan los ataques de desbordamiento de la pila,
es importante entender <a href=https://www.geeksforgeeks.org/memory-layout-of-c-program/ target=_blank rel=noopener>cómo guardan información los programas</a>.</p><p><a href=https://www.eecs.umich.edu/courses/eecs588/static/stack_smashing.pdf target=_blank rel=noopener>«Smashing the stack for fun and profit»</a>
explica relativamente bien cómo funciona todo.</p><p><a href=https://web.archive.org/web/20060919233718/https://inst.eecs.berkeley.edu/~cs164/sp05/ia32-refs/ia32-chapter-three.pdf target=_blank rel=noopener>Cómo funciona la pila en IA32</a>.</p><p><a href=https://eli.thegreenplace.net/2011/09/06/stack-frame-layout-on-x86-64 target=_blank rel=noopener>Cómo funciona la pila en x86_64</a>.</p><p><a href=https://courses.cs.washington.edu/courses/cse351/18wi/lectures/10/CSE351-L10-x86-III_18wi.pdf target=_blank rel=noopener>Más acerca de como funciona el stack en x86-64</a>.</p><h2 id=cómo-se-protegen-los-programas><a href=#c%c3%b3mo-se-protegen-los-programas alt>Cómo se protegen los programas</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Al compilar los programas se pueden activar varias opciones de protección.</p><p><a href=https://mcuoneclipse.com/2019/09/28/stack-canaries-with-gcc-checking-for-stack-overflow-at-runtime/ title="Así funcionan los Canarios de la Pila." target=_blank rel=noopener><code>-stack-protection</code></a>: verifica que las variables se escriban en su lugar.</p><p><code>-pie</code>: genera código que puede moverse en la memoria.</p><p><code>-s</code>: elimina (strips) los símbolos de depuración.</p><p><code>---noexecstack</code>: marca la memoria escribible como no ejecutable (DEP)</p><p>Se pueden revisar opciones de seguridad de los binarios usando:</p><pre tabindex=0><code>checksec --file=${EJECUTABLE}
checksec --directory=${EJECUTABLE}
</code></pre><p><a href=https://wiki.debian.org/Hardening target=_blank rel=noopener>Guía de Debian para proteger los programas</a>.</p><h2 id=cómo-demostrar-programas-vulnerables><a href=#c%c3%b3mo-demostrar-programas-vulnerables alt>Cómo demostrar programas vulnerables</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Para aprender los básicos acerca de cómo atacar programas,
conviene <a href=https://stackoverflow.com/questions/2340259/how-to-turn-off-gcc-compiler-optimization-to-enable-buffer-overflow target=_blank rel=noopener>deshabilitar las funciones de seguridad en la compilación de los programas</a>,
<a href=https://reverseengineering.stackexchange.com/a/27682 target=_blank rel=noopener>incluyendo RELRO</a>.</p><pre tabindex=0><code>gcc \
    -fno-stack-protector \
    -no-pie \
    -Wl,-z,norelro,execstack \
    -o ${PROGRAM} \
    ${SOURCE}
</code></pre><p>En varios sitios recomiendan además <a href=https://0x10f8.wordpress.com/2019/05/21/subverting-nx-bit-with-return-to-libc/ target=_blank rel=noopener>desactivar ASLR en la configuración del kernel</a>:</p><pre tabindex=0><code># echo 0 &gt; /proc/sys/kernel/randomize_va_space
</code></pre><p>Sobrescribir la pila,
permite controlar el flujo de ejecución del programa
porque <a href=http://theamazingking.com/tut2.php target=_blank rel=noopener>en la pila se guardan los punteros para continuar la ejecución del programa</a>.</p><h2 id=ejecutar-programas-desde-la-pila><a href=#ejecutar-programas-desde-la-pila alt>Ejecutar programas desde la pila</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>En la mayoría de los casos los sistemas operativos actualizados
impiden la ejecución de código en la pila
aunque <a href=https://stackoverflow.com/a/3756315/10467443 target=_blank rel=noopener>es posible que algunos dispositivos embebidos aún contengan esta vulnerabilidad</a></p><p><a href=https://stackoverflow.com/a/3755573/10467443 target=_blank rel=noopener>Esta respuesta de Stack Overflow</a>
lista algunos punteros para desactivar las protecciones:</p><blockquote><p>&ldquo;- Disable stack protection at the OS level.</p><ul><li>Allow execution from the stack on a particular executable file.</li><li>mprotect() the stack.</li><li>Maybe some other things&mldr;&rdquo;</li></ul></blockquote><p>Esta medida de seguridad es difícil de desactivar
porque <a href=https://security.stackexchange.com/a/230816/274242 target=_blank rel=noopener>se tiene que desactivar en todo el sistema operativo
y no puede desactivarse únicamente para un programa
o dentro de un contenedor</a>.</p><p>Por lo tanto, para montar estos juegos,
estoy considerando usar alguna máquina virtual ultra ligera:</p><ul><li><p>Alpine sobre <code>QEMU</code>:</p><p>Sospecho que esta va a ser la forma más sencilla de levantar un servicio
que tenga desactivado ASLR.</p></li><li><p><a href=https://github.com/miklevin/Levinux title="Sistema operativo que se ejecuta en RAM y tiene mensajes para aprendizaje" target=_blank rel=noopener>Levinux</a>:</p><p>Me llamó la atención porque
funciona en los 3 sistemas operativos mayoritarios
tiene un perspectiva educativa
y al parecer algunos tutoriales.
<a href=https://mikelev.in/2011/08/virtual-machine-runs-anywhere/ title="Aunque probablemente use alpine sobre QEMU de todas formas." target=_blank rel=noopener>Aquí está un post acerca de cómo se hizo Levinux</a>.
Al final es un <code>QEMU</code>.</p></li></ul><h2 id=cómo-aprovechar-la-vulnerabilidad-de-los-programas-para-ejecutar-código-arbitrario><a href=#c%c3%b3mo-aprovechar-la-vulnerabilidad-de-los-programas-para-ejecutar-c%c3%b3digo-arbitrario alt>Cómo aprovechar la vulnerabilidad de los programas para ejecutar código arbitrario</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Si tienes suficiente espacio en un programa vulnerable,
puedes escribir una función arbitraria en la memoria del programa.</p><p>Hay <a href=http://shell-storm.org/shellcode/ target=_blank rel=noopener>inventarios de funciones en ensamblador para ataques de overflow</a>.</p><p>En caso contrario, <a href=https://insecure.org/stf/smashstack.html target=_blank rel=noopener>puedes escribir el código en el entorno
y apuntar el puntero de retorno a tu código</a>.</p><h2 id=cómo-atacar-la-memoria-cuándo-está-protegida><a href=#c%c3%b3mo-atacar-la-memoria-cu%c3%a1ndo-est%c3%a1-protegida alt>Cómo atacar la memoria cuándo está protegida</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Se puede utilizar el código que ya está en memoria para construir programas arbitrarios,
eso se conoce como <a href=https://en.wikipedia.org/wiki/Return-oriented_programming target=_blank rel=noopener>return-oriented programming (ROP)</a>
y <a href=https://seclists.org/bugtraq/1997/Aug/63 target=_blank rel=noopener>este es uno de los primeros ejemplos</a>.</p><p><a href=http://shell-storm.org/talks/ROP_course_lecture_jonathan_salwan_2014.pdf target=_blank rel=noopener>Se pueden generar ataques elaborados con las instrucciones en memoria</a>.</p><p><a href=https://github.com/JonathanSalwan/ROPgadget/tree/master target=_blank rel=noopener>Esta herramienta busca código disponible para construir tus programas</a>.</p></article></main></body></html>