<!doctype html><html lang=es-mx><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Mis anotaciones y trucos para docker.</title><link rel=stylesheet media=screen href=https://joshua.haase.mx/css/theme.min.c631e12f4e2b4b8b5282c3d94590678b7a225e8caccee02c0d37dac1838d6a61.css integrity="sha256-xjHhL04rS4tSgsPZRZBni3oiXoyszuAsDTfawYONamE="><script src=https://hypothes.is/embed.js></script></head><body><main><article><h1>Mis anotaciones y trucos para docker.</h1><nav id=TableOfContents><ul><li><a href=#proteger-secretos-en-docker>Proteger secretos en <code>docker</code></a></li><li><a href=#seguridad-en-docker>Seguridad en docker</a></li><li><a href=#respaldar-información-de-volúmenes-docker>Respaldar información de volúmenes docker</a></li><li><a href=#cómo-usar-los-puertos>Cómo usar los puertos</a></li><li><a href=#conviene-usar-un-dnscache-dentro-de-docker>¿Conviene usar un <code>dnscache</code> dentro de docker?</a></li><li><a href=#obtener-información-acerca-de-un-contenedor>Obtener información acerca de un contenedor</a></li><li><a href=#desplegar-imágenes-a-un-repositorio-remoto>Desplegar imágenes a un repositorio remoto</a></li><li><a href=#copiar-volúmenes-de-docker-a-servidor-remoto>Copiar volúmenes de docker a servidor remoto</a></li><li><a href=#orquestar-con-docker-compose>Orquestar con <code>docker-compose</code></a></li><li><a href=#gestionar-las-redes-de-docker>Gestionar las redes de docker</a></li><li><a href=#minimizar-el-tamaño-de-las-imágenes>Minimizar el tamaño de las imágenes</a></li><li><a href=#recomendaciones-para-gestión>Recomendaciones para gestión</a></li><li><a href=#varias-recomendaciones-de-seguridad>Varias recomendaciones de seguridad</a></li><li><a href=#docker-ahora-se-puede-ejecutar-sin-root>Docker ahora se puede ejecutar sin root</a></li><li><a href=#usar-docker-desde-ubuntu>Usar <code>docker</code> desde ubuntu</a></li></ul></nav><p>Cuando tienes un contenedor que quieres usar como imagen:</p><pre tabindex=0><code>docker commit contenedor nombre-imagen:etiqueta
</code></pre><p><a href=https://vsupalov.com/override-docker-compose-dot-env/ target=_blank rel=noopener>El entorno de la consola tiene preferencia sobre los valores en el archivo de entorno</a>.</p><p><a href=https://ubuntu.com/blog/how-many-containers-can-you-run-on-your-machine title="536 contenedores vs 37 KVM de acuerdo a esta prueba de estrés." target=_blank rel=noopener>Se pueden utilizar muchos más contenedores que máquinas vituales</a></p><h2 id=proteger-secretos-en-docker><a href=#proteger-secretos-en-docker alt>Proteger secretos en <code>docker</code></a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Usé <a href=https://steinbaugh.com/posts/docker-credential-pass.html target=_blank rel=noopener>este manual para configurar la credencial de docker desde pass.</a></p><p><a href=https://github.com/LanikSJ/dfimage target=_blank rel=noopener><code>dfimage</code> permite ver los archivos de docker</a>.
<a href=https://github.com/CenturyLinkLabs/dockerfile-from-image target=_blank rel=noopener><code>dfimage</code> de CenturyLabs referenciado en 1</a></p><p><a href=https://github.com/jwilder/docker-squash target=_blank rel=noopener><code>docker-squash</code> permite reducir el tamaño y eliminar archivos intermedios.</a></p><p><a href=https://github.com/moby/moby/issues/13490 target=_blank rel=noopener>Un buen resumen de porqué no usar funciones no diseñadas para compartir información sensible dentro de <code>docker</code></a>.</p><p><a href=http://elasticcompute.io/2016/01/22/build-time-secrets-with-docker-containers/ target=_blank rel=noopener>Asegurar secretos en docker para la construcción</a>.</p><p><a href=http://elasticcompute.io/2016/01/21/runtime-secrets-with-docker-containers/ target=_blank rel=noopener>Asegurar secretos en docker en la ejecución</a>.</p><p><a href=https://medium.com/@tonistiigi/build-secrets-and-ssh-forwarding-in-docker-18-09-ae8161d066 target=_blank rel=noopener>Montar repositorios privados en docker con la opción ssh mediante un socket de sólo lectura</a></p><p><a href=https://github.com/mikesir87/dockercon-2020-compose-talk target=_blank rel=noopener>Las posibilidades de <code>docker-compose</code></a>
<a href=https://blog.mikesir87.io/2020/05/dockercon-simplify-all-the-things-docker-compose/ target=_blank rel=noopener>y cómo simplificar el desarrollo</a>.</p><p><a href=https://blog.mikesir87.io/2017/05/using-docker-secrets-during-development/ target=_blank rel=noopener>Usar <code>docker secrets</code> en el desarrollo</a>
y <a href='https://www.youtube.com/watch?v=iHQCVFMBdCA' target=_blank rel=noopener>cómo asegurar toda la infraestructura con docker</a>.</p><p><a href=https://github.com/docker/deploykit target=_blank rel=noopener>Un tutorial de infraestructura segura con <code>infrakit</code></a></p><h2 id=seguridad-en-docker><a href=#seguridad-en-docker alt>Seguridad en docker</a> <a href=# alt="Regresar al inicio">↑</a></h2><p><a href=https://blog.mikesir87.io/2017/05/using-docker-secrets-during-development/ target=_blank rel=noopener>Varios elementos de seguridad</a>:</p><ul><li><code>runC</code>.</li><li>infrakit.</li><li>notary</li><li>containerD.</li><li>docker</li><li>swarmkit</li><li>syscall whitelist.</li><li><code>notary</code>: cryptographic name resolution.</li><li>swarmkit: least privilege container orchestration.</li></ul><p>-> <code>moby</code></p><p><a href=https://github.com/moby/buildkit target=_blank rel=noopener>BuildKit ahora permitiría usar métodos distintos para construir imágenes de docker</a>,
y tiene funciones como <a href=https://jedevc.com/blog/dockerfile-heredocs-intro/ target=_blank rel=noopener><code>heredocs</code> en el Dockerfile</a>
o <a href=https://matt-rickard.com/building-a-new-dockerfile-frontend/ target=_blank rel=noopener>hacer tus propios intérpretes para comandos en docker</a>.</p><p>Se puede además <a href=https://docs.docker.com/engine/security/seccomp/ target=_blank rel=noopener>habilitar perfiles de seguridad <code>seccomp</code></a>,
y <a href=https://www.smarthomebeginner.com/traefik-docker-security-best-practices/ target=_blank rel=noopener>utilizar estas recomendaciones</a>.</p><h2 id=respaldar-información-de-volúmenes-docker><a href=#respaldar-informaci%c3%b3n-de-vol%c3%bamenes-docker alt>Respaldar información de volúmenes docker</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Tengo un script que se llama <code>docker-volume-clone</code> para eso.
La parte importante es como sigue:</p><pre tabindex=0><code>docker run --rm \
           -i \
           -t \
           -v $1:/from \
           -v $2:/to \
           alpine ash -c &#34;cd /from ; cp -av . /to&#34;
</code></pre><h2 id=cómo-usar-los-puertos><a href=#c%c3%b3mo-usar-los-puertos alt>Cómo usar los puertos</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Para interconectar contenedores de docker existen varias formas:</p><ul><li><p><del>Vincular las máquinas usando <code>links</code> en <code>docker-compose.yml</code></del></p><p>Usar links para vincular contenedores ya no es una opción aceptada.</p></li><li><p>Exponer los puertos únicamente en la red interna de docker,
<code>Dockerfile</code> o <code>docker-compose</code>
y agregar la misma red a los contenedores:</p><pre tabindex=0><code>EXPOSE ${PORT}
</code></pre><pre tabindex=0><code>services:
  service_a:
    …
    expose:
    - ${PORT}
    networks:
      - ${NETWORK}
  service_b:
    …
    networks:
      - ${NETWORK}
networks:
  - ${NETWORK}
</code></pre><p>En el ejemplo, el servicio &ldquo;b&rdquo; tiene acceso al servicio &ldquo;a&rdquo;
porque está en la misma red.</p></li><li><p>Permitir el acceso externo a un puerto de un contenedor
agregando en el <code>docker-compose</code>:</p><pre tabindex=0><code>container_name:
  ports:
  - ${HOST_PORT}:${CONTAINER_PORT}
</code></pre><p>O el comando equivalente</p><pre tabindex=0><code>$ docker -p ${HOST_PORT}:${CONTAINER_PORT} ${IMAGE} ${COMMAND}
</code></pre><p>En estos casos,
el servicio del contenedor
está expuesto en el servidor donde se ejecuta <code>docker</code>
y cualquier servicio puede accederlo allí mismo.</p></li></ul><h2 id=conviene-usar-un-dnscache-dentro-de-docker><a href=#conviene-usar-un-dnscache-dentro-de-docker alt>¿Conviene usar un <code>dnscache</code> dentro de docker?</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Aquí hay una <a href=https://web.archive.org/web/20200611084352/http://success.docker.com/article/networking title="vinculada desde https://stackoverflow.com/questions/44724497/what-is-overlay-network-and-how-does-dns-resolution-work" target=_blank rel=noopener>descripción de la gestión de red de docker</a>
que muestra que las solicitudes DNS desde docker
pasan primero por una base de llave:valor
con los servicios dentro de docker.</p><p><figure><img src=https://i.stack.imgur.com/00T8w.png></figure></p><p>Si el contenedor no encuentra los dominios buscados,
<a href=https://kerneltalks.com/networking/how-docker-container-dns-works/ target=_blank rel=noopener>usa el sitema de resolución del servidor donde vive</a>.</p><p>Si tienes múltiples redes,
<a href=https://vegibit.com/how-does-docker-dns-work/ target=_blank rel=noopener>el DNS únicamente muestra los servidores
en las redes a las que pertenece el servicio que hace las solicitudes</a>.</p><p>Entonces <strong>sí</strong>:
configurando un <code>dnscache</code> para el hospedero,
se puede utilizar dentro de los contenedores.</p><h2 id=obtener-información-acerca-de-un-contenedor><a href=#obtener-informaci%c3%b3n-acerca-de-un-contenedor alt>Obtener información acerca de un contenedor</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Las etiquetas de los contenedores pueden verse con el comando:</p><pre tabindex=0><code>$ docker inspect [contenedor]
</code></pre><h2 id=desplegar-imágenes-a-un-repositorio-remoto><a href=#desplegar-im%c3%a1genes-a-un-repositorio-remoto alt>Desplegar imágenes a un repositorio remoto</a> <a href=# alt="Regresar al inicio">↑</a></h2><p><a href=https://www.docker.com/blog/how-to-deploy-on-remote-docker-hosts-with-docker-compose/ target=_blank rel=noopener>Hay varias formas de desplegar a repositorios remotos</a>:</p><ul><li>Variable de entorno <code>DOCKER_HOST</code></li><li><a href=https://docs.docker.com/engine/context/working-with-contexts/ target=_blank rel=noopener>Docker context</a></li></ul><pre tabindex=0><code>docker --context=${CONTEXT} ${COMMAND}
</code></pre><h2 id=copiar-volúmenes-de-docker-a-servidor-remoto><a href=#copiar-vol%c3%bamenes-de-docker-a-servidor-remoto alt>Copiar volúmenes de docker a servidor remoto</a> <a href=# alt="Regresar al inicio">↑</a></h2><p><a href=https://stackoverflow.com/questions/41651212/how-to-move-a-local-volume-onto-a-remote-docker-machine target=_blank rel=noopener>La respuesta recomendada es generar un contenedor de docker, montar los volúmenes y copiar los datos</a></p><p>Yo me descargué los <a href=https://github.com/gdiepen/docker-convenience-scripts target=_blank rel=noopener>scripts para conveniencia de uso de docker</a>
y ahora puedo usar <code>docker-volume-clone origin destination</code>.</p><pre tabindex=0><code>docker run alpine -v ${VOLUME_FROM} tar -cf - \
| ssh docker run alpine -v ${VOLUME_TO} tar -xf -
</code></pre><h2 id=orquestar-con-docker-compose><a href=#orquestar-con-docker-compose alt>Orquestar con <code>docker-compose</code></a> <a href=# alt="Regresar al inicio">↑</a></h2><p><code>docker-compose</code> sirve para orquestar aplicaciones con contenedores.</p><p><a href=https://aws.amazon.com/blogs/compute/amazon-ecs-and-docker-volume-drivers-amazon-ebs/ target=_blank rel=noopener>AWS tiene un servicio para usar contenedores</a></p><p>Hay instrucciones para ejecutar contenedores en ECS
<a href=https://www.docker.com/blog/docker-compose-from-local-to-amazon-ecs/ target=_blank rel=noopener>en el blog de docker</a>
y <a href=https://aws.amazon.com/blogs/containers/deploy-applications-on-amazon-ecs-using-docker-compose/ target=_blank rel=noopener>en el blog de AWS</a>.
Hay ciertos <a href=https://docs.docker.com/cloud/ecs-integration/ target=_blank rel=noopener>requisitos que deben cumplirse para poder usar ECS desde docker-compose</a>
además <a href=https://docs.docker.com/cloud/ecs-compose-examples/ target=_blank rel=noopener>se tienen que modificar para ejecutarse en ECS</a>.</p><h2 id=gestionar-las-redes-de-docker><a href=#gestionar-las-redes-de-docker alt>Gestionar las redes de docker</a> <a href=# alt="Regresar al inicio">↑</a></h2><p><a href=https://www.naturalborncoder.com/linux/2021/02/19/making-a-docker-container-use-a-vpn/ target=_blank rel=noopener>Los contenedores de docker no usan la configuración de red del servidor</a>
y por lo tanto podrían saltarse restricciones de red como el uso de VPN.</p><p>Para corregir eso,
<a href=https://www.naturalborncoder.com/linux/2021/02/19/making-a-docker-container-use-a-vpn/ target=_blank rel=noopener>una alternativa es generar un servicio que gestione la VPN</a>
y vincular la red de los demás contenedores con ella</p><p>Si se hace esto, debe tenerse cuidado de referirse a cada servicio como <code>localhost:${PORT}</code>.</p><p><a href=https://docs.docker.com/engine/reference/run/#network-settings target=_blank rel=noopener>Es preferible usar los controladores de red que enlazar imágenes</a>.</p><p><a href=https://stackoverflow.com/questions/58377469/difference-between-cap-add-net-admin-and-add-capabilities-in-yml target=_blank rel=noopener>Si un contenedor debe interactuar con la red se le debe agregar la capacidad NET_ADMIN</a></p><h2 id=minimizar-el-tamaño-de-las-imágenes><a href=#minimizar-el-tama%c3%b1o-de-las-im%c3%a1genes alt>Minimizar el tamaño de las imágenes</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Para desactivar <code>/etc/docker/daemon.json</code>:</p><pre tabindex=0><code># file: /etc/docker/daemon.json
{ &#34;experimental&#34;: &#34;true&#34; }
</code></pre><p>Usar multi-etapas para construir las aplicaciones:</p><pre tabindex=0><code># file: Dockerfile
FROM image:tag as builder
[…]
FROM scratch
COPY --from=builder /from […] /to
</code></pre><p><a href=https://mresetar.github.io/2020-03-20-squashing-docker-images-for-smaller-size/ target=_blank rel=noopener>Squash the image</a>:</p><pre tabindex=0><code>docker build --squash .
</code></pre><h2 id=recomendaciones-para-gestión><a href=#recomendaciones-para-gesti%c3%b3n alt>Recomendaciones para gestión</a> <a href=# alt="Regresar al inicio">↑</a></h2><p><a href=https://developers.redhat.com/blog/2016/02/24/10-things-to-avoid-in-docker-containers target=_blank rel=noopener>Este artículo de desarrolladores RedHat</a>
recomienda usar varias capas para gestionar el contenedor:</p><ul><li>Sistema operativo</li><li>Definición de usuarios</li><li>Instalación de la aplicación</li></ul><h2 id=varias-recomendaciones-de-seguridad><a href=#varias-recomendaciones-de-seguridad alt>Varias recomendaciones de seguridad</a> <a href=# alt="Regresar al inicio">↑</a></h2><ul><li><p><a href=https://docs.docker.com/go/rootless/ target=_blank rel=noopener>Ya es posible usar <code>docker</code> sin <code>root</code></a>.</p></li><li><p>Evitar usar <code>root</code> para ejecutar procesos en los contenedores.</p></li><li><p>Evitar guardar credenciales en las imágenes.</p></li></ul><h2 id=docker-ahora-se-puede-ejecutar-sin-root><a href=#docker-ahora-se-puede-ejecutar-sin-root alt>Docker ahora se puede ejecutar sin root</a> <a href=# alt="Regresar al inicio">↑</a></h2><p><a href=https://docs.docker.com/engine/security/rootless/ target=_blank rel=noopener>https://docs.docker.com/engine/security/rootless/</a></p><p>Intenté arreglar docker pero no parece funcionar,
<a href=https://forums.docker.com/t/a-couple-of-issues-i-ran-into-tinkering-with-docker-20-10-0-rootless-mode/101613/2 target=_blank rel=noopener>este es el sitio con mejor información</a>,
porque <a href=https://github.com/goharbor/harbor/issues/19202 target=_blank rel=noopener>este reporte</a> sólo dice que es &ldquo;hardening&rdquo;,
<a href=https://studiouv.com/docker-service-wont-start-interactive-authentication-required/ target=_blank rel=noopener>esto</a> que use root,
y esto que <a href=https://serverfault.com/questions/1122063/rootless-docker-fails-with-systemd-error-interactive-authentication-required target=_blank rel=noopener>desactive <code>systemd.unified_cgroup_hierarchy=0</code></a>.</p><p><a href=https://github.com/moby/moby/issues/45014#issuecomment-2103777986 target=_blank rel=noopener>Esto recmienda cambiar una configuración</a></p><p>~/.config/docker/daemon.json</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{<span style=color:#f92672>&#34;exec-opts&#34;</span>: [<span style=color:#e6db74>&#34;native.cgroupdriver=cgroupfs&#34;</span>]}
</span></span></code></pre></div><ul><li><input disabled type=checkbox> <a href=https://serverfault.com/questions/1122063/rootless-docker-fails-with-systemd-error-interactive-authentication-required target=_blank rel=noopener>responder acá</a></li></ul><h2 id=usar-docker-desde-ubuntu><a href=#usar-docker-desde-ubuntu alt>Usar <code>docker</code> desde ubuntu</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Al instalar docker desde una máquina ubuntu,
<code>docker</code> no era capaz de ejecutar <a href=https://github.com/xihh87/lbustio.com/ target=_blank rel=noopener>los servicios de cierta infraestructura que administro</a>
y por lo tanto:</p><ul><li><p>Desinstalé todo lo que tiene que ver con <code>docker</code></p><pre tabindex=0><code>apt-get purge docker.io docker-compose
</code></pre></li><li><p>Usé el script de instalación oficial de docker:</p><pre tabindex=0><code>curl -sSL https://get.docker.com/ | sh
</code></pre></li></ul><hr><p><a href=https://docs.docker.com/engine/security/protect-access/ target=_blank rel=noopener>Se puede usar TLS para el socket de docker</a></p></article></main></body></html>