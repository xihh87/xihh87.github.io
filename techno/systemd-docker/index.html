<!doctype html><html lang=es-mx><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Cómo usar systemd en docker</title><link rel=stylesheet media=screen href=https://joshua.haase.mx/css/theme.min.2ee1317322f9eb9b2ef0a618d19b20e38c11f5f9c310751400a45db225dd2626.css integrity="sha256-LuExcyL565su8KYY0Zsg44wR9fnDEHUUAKRdsiXdJiY="><script src=https://hypothes.is/embed.js></script></head><body><main><article><h1>Cómo usar <code>systemd</code> en docker</h1><nav id=TableOfContents><ul><li><a href=#podman><a href=../podman/><code>podman</code> puede ejecutar <code>systemd</code></a></a></li><li><a href=#cómo-hacer-funcionar-docker-en-osx>Cómo hacer funcionar docker en OSX</a></li><li><a href=#en-systemas-linux-para-docker--20106-y-systemd--248>En systemas Linux, para <code>docker &lt; 20.10.6</code> y <code>systemd &lt; 248</code></a></li><li><a href=#usar-systemd-dentro-de-docker-después-de-la-versión-248>Usar <code>systemd</code> dentro de docker después de la versión 248</a><ul><li><a href=#-activar-cgroup-v1-en-la-configuración-de-arranque>☒ Activar <code>cgroup v1</code> en la configuración de arranque</a></li><li><a href=#-compilar-systemd-para-usar-legacy-e-instalarlo-en-el-contenedor>☒ Compilar <code>systemd</code> para usar legacy e instalarlo en el contenedor</a></li></ul></li></ul></nav><h2 id=podman><a href=#podman alt><a href=../podman/><code>podman</code> puede ejecutar <code>systemd</code></a></a> <a href=# alt="Regresar al inicio">↑</a></h2><p>A partir de <code>systemd >= 248</code> y <code>docker >= 20.10.6</code>
<a href=https://github.com/hercules-ci/arion/issues/122#issue-913386120 title="Entiendo que es 20.10.5, porque la versión más reciente de docker hoy (2022-03) es 20.10.12" target=_blank rel=noopener>no puede ejecutarse <code>systemd</code> dentro de <code>docker</code></a>.</p><p>La solución es migrar a <code>podman</code>,
<a href=https://developers.redhat.com/blog/2019/04/24/how-to-run-systemd-in-a-container target=_blank rel=noopener>que está optimizado para ejecutar <code>systemd</code></a>.</p><h2 id=cómo-hacer-funcionar-docker-en-osx><a href=#c%c3%b3mo-hacer-funcionar-docker-en-osx alt>Cómo hacer funcionar docker en OSX</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Hoy diagnostiqué cómo hacer funcionar <a href=https://github.com/moby/moby/issues/30723 target=_blank rel=noopener>systemd en OSX</a>
porque es la virtualización que funciona en una mac nueva con arquitectura ARM.
<a href=https://www.xataka.com/ordenadores/posible-usar-windows-linux-nuevos-mac-chip-m1-que-viva-virtualizacion target=_blank rel=noopener>Aún no funciona Parallels o VMWare aún no funcionan en Apple M1</a>
aunque <a href=https://lists.gnu.org/archive/html/qemu-devel/2020-11/msg06499.html target=_blank rel=noopener>parece que qemu sí</a>.</p><p>Para construir la imagen de docker usé este <code>dockerfile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>&amp;&amp;</span> apt-get install -y --no-install-recomends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  systemd <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  systemd-cron<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> https://raw.githubusercontent.com/geerlingguy/docker-ubuntu2004-ansible/master/initctl_faker<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mv /initctl_faker /sbin/initctl <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>&amp;&amp;</span> chmod +x /sbin/initctl<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>STOPSIGNAL</span><span style=color:#e6db74> SIGRTMIN+3</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;/lib/systemd/systemd&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Y en el <code>docker-compose.yml</code> aguregué estas opciones de seguridad
para que funcione <code>systemd</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker-compose.yml data-lang=docker-compose.yml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nombre:etiqueta</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>privileged</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>cap_add</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>SYS_ADMIN</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>security_opt</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>seccomp:unconfined</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tmpfs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/run</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/run/lock</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/sys/fs/cgroup</span>
</span></span></code></pre></div><p>Podría ser que funcione <a href=https://github.com/moby/moby/issues/9950#issuecomment-442713669 target=_blank rel=noopener>sin desactivar las opciones de seguridad</a>.</p><h2 id=en-systemas-linux-para-docker--20106-y-systemd--248><a href=#en-systemas-linux-para-docker--20106-y-systemd--248 alt>En systemas Linux, para <code>docker &lt; 20.10.6</code> y <code>systemd &lt; 248</code></a> <a href=# alt="Regresar al inicio">↑</a></h2><p><a href=https://developers.redhat.com/blog/2016/09/13/running-systemd-in-a-non-privileged-container#docker_upstream_vs__systemd target=_blank rel=noopener>En otros linux se podía usar docker sin permisos adicionales</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker-compose.yml data-lang=docker-compose.yml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nombre:etiqueta</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tmpfs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/run</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/run/lock</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volume</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>/sys/fs/cgroup:/sys/fs/cgroup:ro</span>
</span></span></code></pre></div><p>En el <code>dockerfile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>STOPSIGNAL</span><span style=color:#e6db74> SIGRTMIN+3</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=usar-systemd-dentro-de-docker-después-de-la-versión-248><a href=#usar-systemd-dentro-de-docker-despu%c3%a9s-de-la-versi%c3%b3n-248 alt>Usar <code>systemd</code> dentro de docker después de la versión 248</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Dado que</p><blockquote><p><a href=https://github.com/hercules-ci/arion/issues/122#issue-913386120 title="Entiendo que es 20.10.5, porque la versión más reciente de docker hoy (2022-03) es 20.10.12" target=_blank rel=noopener>&ldquo;Systemd and docker have become incompatible since <del>21.05</del> and cgroupsv2.&rdquo;</a></p></blockquote><p><a href=https://unix.stackexchange.com/questions/305340/how-to-run-systemd-services-in-arch-linux-docker-container target=_blank rel=noopener>compartir el <code>cgroup</code></a>
dejó de funcionar como solución
<a href='https://bbs.archlinux.org/viewtopic.php?id=267110' target=_blank rel=noopener>y se sabe que está roto</a>.</p><h3 id=-activar-cgroup-v1-en-la-configuración-de-arranque><a href=#-activar-cgroup-v1-en-la-configuraci%c3%b3n-de-arranque alt>☒ Activar <code>cgroup v1</code> en la configuración de arranque</a> <a href=# alt="Regresar al inicio">↑</a></h3><p><a href=https://dangibbs.uk/blog/running-systemd-docker-containers-archlinux/ target=_blank rel=noopener>Desactivar la jerarquía híbrida de systemd</a>
en <code>/etc/default/grub</code>:</p><pre tabindex=0><code># file: /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT=&#34;&#34;
GRUB_CMDLINE_LINUX=&#34;quiet systemd.unified_cgroup_hierarchy=0&#34;
</code></pre><p>y regenerar la configuración con <code>grub-mkconfig -o /boot/grub/grub.cfg</code>.</p><p>Dado que <code>cgroup v1</code> se mantiene menos que <code>cgroup v2</code>
esto <a href=https://unit42.paloaltonetworks.com/cve-2022-0492-cgroups/ target=_blank rel=noopener>podría dar lugar a problemas de seguridad</a>.</p><p>(Por otro lado, <a href=https://ubuntu.com/security/CVE-2022-0185 target=_blank rel=noopener>hay que recordar que «los contenedores no detienen [amenazas de seguridad]»</a>).</p><p>Al parecer a partir de ahora, <a href=../testing-iac/>será necesario hacer VM para mis pruebas de config</a>.</p><h3 id=-compilar-systemd-para-usar-legacy-e-instalarlo-en-el-contenedor><a href=#-compilar-systemd-para-usar-legacy-e-instalarlo-en-el-contenedor alt>☒ Compilar <code>systemd</code> para usar legacy e instalarlo en el contenedor</a> <a href=# alt="Regresar al inicio">↑</a></h3><p>Al parecer <a href=https://github.com/systemd/systemd/issues/13477#issuecomment-528076476 target=_blank rel=noopener>los gestores de contenedores no soportan la configuración de <code>systemd</code> cgroups v2.</a></p></article></main></body></html>