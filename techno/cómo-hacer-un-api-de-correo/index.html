<!doctype html><html lang=es-mx><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Cómo hice una API de correo con AWS Lambda</title><link rel=stylesheet media=screen href=https://joshua.haase.mx/css/theme.min.c631e12f4e2b4b8b5282c3d94590678b7a225e8caccee02c0d37dac1838d6a61.css integrity="sha256-xjHhL04rS4tSgsPZRZBni3oiXoyszuAsDTfawYONamE="><script src=https://hypothes.is/embed.js></script></head><body><main><article><h1>Cómo hice una API de correo con AWS Lambda</h1><nav id=TableOfContents><ul><li><a href=#configurar-gateway-api-para-usar-una-función-lambda>Configurar Gateway API para usar una función Lambda</a></li></ul></nav><p><a href=https://stackoverflow.com/questions/33662842/simple-python-server-to-process-get-and-post-requests-with-json target=_blank rel=noopener>Usar una interfaz POST desde python</a>:</p><ul><li><p><a href=https://bottlepy.org/docs/dev/tutorial.html#quickstart-hello-world target=_blank rel=noopener>bottle</a></p><p><a href=https://stackoverflow.com/questions/26865432/converting-bottle-formsdict-to-a-python-dictionary-in-a-thread-safe-way target=_blank rel=noopener>Convertir bottle a diccionario</a></p></li><li><p><a href=https://gist.github.com/earonesty/ab07b4c0fea2c226e75b3d538cc0dc55 target=_blank rel=noopener>ApiServer</a></p></li></ul><p><a href=https://stackify.com/aws-lambda-with-python-a-complete-getting-started-guide/ target=_blank rel=noopener>Cómo usar una lambda de AWS</a></p><p><a href=https://blog.summercat.com/using-aws-lambda-and-api-gateway-as-html-form-endpoint.html target=_blank rel=noopener>Usar Lambda de AWS para responder mensajes</a></p><p><a href=https://johnroach.io/2020/09/04/deploying-lambda-functions-with-terraform-just-dont/ target=_blank rel=noopener>Joan Roach recomienda no usar Terraform para desplegar lambdas</a>
porque el despliegue de la arquitectura se acopla al código
y al cambiar se regenera toda la arquitectura.</p><p><a href=https://medium.com/paul-zhao-projects/sending-emails-with-python-c084b55a2857 target=_blank rel=noopener>Tutorial paso a paso para cuenta de Gmail</a>
<a href=https://realpython.com/python-send-email/ target=_blank rel=noopener>Enviar correos desde python</a>
<a href=https://medium.com/paul-zhao-projects/sending-emails-with-python-c084b55a2857 target=_blank rel=noopener>Enviar correos desde python</a></p><p><a href=https://stackoverflow.com/questions/3728528/testing-email-sending-in-django target=_blank rel=noopener>Cómo enviar correos en django</a></p><p><a href=https://aws.amazon.com/es/ses/ target=_blank rel=noopener>API para enviar correos sistema de Amazon Simple Email Service</a>
<a href=https://www.netlify.com/blog/2017/09/19/form-handling-with-the-jamstack-and-netlify/ target=_blank rel=noopener>Un tutorial de formas en Jamstack</a>
<a href=https://html.form.guide/contact-form/html-contact-form-captcha/ target=_blank rel=noopener>Cómo agregar CAPTCHA en PHP</a></p><hr><p><a href=https://bezdelev.com/hacking/hugo-aws-lambda-static-website-amazon-s3/ target=_blank rel=noopener>Tutorial para subir tu sitio Hugo a AWS</a>
y <a href=https://github.com/ryansb/hugo-lambda target=_blank rel=noopener>el código de un proyecto que usa lambda para su sitio de Hugo</a>.</p><p><a href=https://medium.com/ottofellercom/aws-lambdas-free-tier-is-the-best-way-to-host-your-websites-for-free-isn-t-it-588689ca7269 target=_blank rel=noopener>Lambda es una buena opción para tu sitio</a></p><p><a href=https://aws.amazon.com/es/premiumsupport/knowledge-center/account-transfer-s3/ target=_blank rel=noopener>Si en mis pruebas subo cosas a S3, tengo que copiarlas a la cuenta nueva</a></p><p><a href=https://www.mailgun.com/pricing target=_blank rel=noopener>Mailgun es gratis si usas menos de 5000 mensajes mensuales los primero 3 meses y luego cada 100 correos cuestan USD $0.80</a></p><h2 id=configurar-gateway-api-para-usar-una-función-lambda><a href=#configurar-gateway-api-para-usar-una-funci%c3%b3n-lambda alt>Configurar Gateway API para usar una función Lambda</a> <a href=# alt="Regresar al inicio">↑</a></h2><ul><li><p>[✓] Configurar <a href=https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-troubleshooting-lambda.html target=_blank rel=noopener>permisos para que el Gateway API ejecute la Lambda</a></p><pre tabindex=0><code>aws lambda add-permission \
   --statement-id 9c196712-e4a3-551e-837c-038a9e150c07 \
   --action lambda:InvokeFunction \
   --function-name &#34;arn:aws:lambda:us-west-2:840814578750:function:cyberlogistics_warranty_mail&#34; \
   --principal apigateway.amazonaws.com \
   --source-arn &#34;arn:aws:execute-api:us-west-2:840814578750:4laotki9a7/*/*/warranty&#34;

c61c0278-7235-5e16-b926-b9844e283057
</code></pre></li></ul><p>Amazon tiene un servicio para redirigir peticiones HTTP (Gateway API)
que se puede interconectar con
el servicio que ejecuta funciones en respuesta a eventos (Lambda).</p><p>El sistema se puede usar para responder peticiones de formularios,
pero tiene que <a href=https://stackoverflow.com/questions/38599028/parse-multipart-form-data-from-body-as-string-on-aws-lambda target=_blank rel=noopener>procesar</a>
<a href=https://dev.to/craftzdog/how-to-add-a-contact-form-to-a-static-website-with-aws-lambda-2299 target=_blank rel=noopener>peticiones</a>
<a href=https://www.agiliq.com/blog/2019/09/python-multipart/ target=_blank rel=noopener>multiparte</a>.</p><p>En <a href=https://gitlab.com/xihh87/mail-api.git target=_blank rel=noopener>este repositorio</a> tengo un makefile
con los comandos para generar una lambda que procesa formas web multiparte.</p><p><a href=https://github.com/lambci/docker-lambda title="Vía https://medium.com/@johnnyopao/python-dependencies-and-aws-lambda-18acbdebca20 , que tiene instrucciones para diagnosticar problemas" target=_blank rel=noopener>Esta imagen de docker replica el entorno de lambda para hacer pruebas locales</a></p><p><a href=https://joarleymoraes.com/hassle-free-python-lambda-deployment/ target=_blank rel=noopener>Un instructivo para iniciar una función de AWS Lambda</a>.</p><p><a href=https://docs.aws.amazon.com/lambda/latest/dg/python-package-create.html target=_blank rel=noopener>La documentación de Amazon para hacer funciones AWS Lambda en python</a>.</p><p><a href=https://www.develandoo.com/blog/parsing-multipart-body-aws-lambda-function-serverless/ target=_blank rel=noopener>Instructivo para procesar peticione multipart en AWS Lambda con Node.js</a>.</p><p><a href=https://docs.aws.amazon.com/lambda/latest/dg/python-context.html target=_blank rel=noopener>La documentación de AWS Lambda para procesar el contexto en python</a></p><p><a href=https://stackify.com/aws-lambda-with-python-a-complete-getting-started-guide/ target=_blank rel=noopener>Un manual para hacer una función de AWS Lambda que procesa una imagen</a>.</p><p><a href='https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-logging.html?icmpid=apigateway_console_help' target=_blank rel=noopener>Cómo activar los logs en API Gateway</a>.</p><p>Se puede usar para procesar los eventos alguna de estas funciones.</p><ul><li><a href=https://docs.aiohttp.org/en/latest/multipart_reference.html#aiohttp.MultipartReader target=_blank rel=noopener><code>multipart</code></a></li><li><a href=#ZgotmplZ><code>python-multipart</code></a></li></ul><p><a href=https://codeolives.com/2020/04/05/api-gateway-internal-server-error-execution-failed-due-to-configuration-error-malformed-lambda-proxy-response/ target=_blank rel=noopener>El formato de las solicitudes para API Gateway es estricto</a>.</p><hr><p>Al final, resumiendo el procedimiento:</p><ol><li>Generar una política para permitir el envío de correos con cierta identidad:</li></ol><pre tabindex=0><code></code></pre><ol><li><p>Generar una cuenta con permisos para utilizar el servicio SES y enviar correos.</p></li><li><p><a href=https://docs.aws.amazon.com/ses/latest/dg/creating-identities.html#verify-domain-procedure target=_blank rel=noopener>Generar los registros en el DNS</a> para que AWS verifique el dominio y pueda enviar correos.</p></li><li><p>Generar una función AWS Lambda que envíe el correo.</p></li><li><p>Generar un Gateway API que asocie el correo con la función correcta.</p></li></ol></article></main></body></html>