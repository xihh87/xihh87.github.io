<!doctype html><html lang=es-mx><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Pruebas unitarias sobre SQL</title><link rel=stylesheet media=screen href=https://joshua.haase.mx/css/theme.min.c631e12f4e2b4b8b5282c3d94590678b7a225e8caccee02c0d37dac1838d6a61.css integrity="sha256-xjHhL04rS4tSgsPZRZBni3oiXoyszuAsDTfawYONamE="><script src=https://hypothes.is/embed.js></script></head><body><main><article><h1>Pruebas unitarias sobre SQL</h1><nav id=TableOfContents><ul><li><a href=#contexto>Contexto</a></li><li><a href=#buenas-prácticas-en-sql>Buenas prácticas en SQL</a></li><li><a href=#refactorizar-bases-de-datos>Refactorizar bases de datos</a></li><li><a href=#herramientas-para-pruebas-unitarias-sql>Herramientas para pruebas unitarias SQL</a></li><li><a href=#otras-herramientas-para-trabajar-sql>Otras herramientas para trabajar SQL</a></li><li><a href=#bases-de-datos-efímeras>Bases de datos efímeras</a><ul><li><a href=#usar-base-de-datos-efímera-para-testing>Usar base de datos efímera para testing</a></li><li><a href=#estoy-implementando-una-biblioteca-para-probar-consultas-en-mysql>Estoy implementando una biblioteca para probar consultas en mysql</a></li></ul></li><li><a href=#cómo-verificar-inserts>Cómo verificar INSERTs</a></li><li><a href=#convertir-volcados-de-tablas-de-base-de-datos-en-csv>Convertir volcados de tablas de base de datos en CSV</a></li><li><a href=#herramientas-para-flujos-extraer-transformar-cargar>Herramientas para flujos Extraer-Transformar-Cargar</a></li><li><a href=#usar-procedimientos-en-la-base-de-datos>¿Usar procedimientos en la base de datos?</a><ul><li><a href=#ventajas>Ventajas</a></li><li><a href=#desventajas>Desventajas</a></li><li><a href=#cómo-cambiar-procedimientos>Cómo cambiar procedimientos</a></li></ul></li><li><a href=#generar-datos-para-probar-consultas>Generar datos para probar consultas</a></li><li><a href=#optimizar-inicio-de-mysql>Optimizar inicio de mysql</a></li><li><a href=#otras-optimizaciones>Otras optimizaciones</a></li><li><a href=#enlaces-interesantes>Enlaces interesantes</a></li><li><a href=#fuentes-de-información>Fuentes de información</a></li></ul></nav><h2 id=contexto><a href=#contexto alt>Contexto</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Con <a href=https://learnsql.com/blog/what-is-common-table-expression/ target=_blank rel=noopener>expresiones comunes de tablas</a>
<a href=https://www.geeksforgeeks.org/cte-in-sql/ target=_blank rel=noopener>(CTE)</a>
y <a href=https://www.geeksforgeeks.org/window-functions-in-sql/ title="Window functions" target=_blank rel=noopener>funciones de ventana</a>
<a href=https://web.archive.org/web/20160210101320/https://assets.en.oreilly.com/1/event/27/High%20Performance%20SQL%20with%20PostgreSQL%20Presentation.pdf title="SQL with CTE and windowing is turing complete" target=_blank rel=noopener>SQL es computacionalmente completo</a>.</p><p><figure><img src=https://stayhipp.com/wp-content/uploads/2018/10/Change-My-Mind.jpg><figcaption>All apps are database frontends</figcaption></figure></p><p>Dado que <a href=/techno/desarrollo#desarrollo-dirigido-por-pruebas-tdd>me gusta desarrollar usando TDD</a>
y tengo un proyecto que involucra consultas complejas,
investigué la forma de comprobar las consultas.</p><h2 id=buenas-prácticas-en-sql><a href=#buenas-pr%c3%a1cticas-en-sql alt>Buenas prácticas en SQL</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Conviene normalizar la base de datos
para simplificar los cambios
y optimizar los tiempos de consulta.
Para consultas complejas conviene generar índices.</p><p>Una vez que se optimizó la base de datos,
conviene optimizar el hardware para sacarle el mejor provecho.</p><p>Así como los procesos se pueden descomponer en funciones,
<a href=https://stackoverflow.com/questions/754527/best-way-to-test-sql-queries/754570#754570 target=_blank rel=noopener>las consultas se pueden descomponer</a> en <a href=https://www.geeksforgeeks.org/sql-views/ target=_blank rel=noopener>vistas</a> o CTE
(pero <a href=https://learnsql.com/blog/difference-between-sql-cte-and-view/ target=_blank rel=noopener>conviene usar vistas para las ejecutadas frecuentemente</a>).</p><p><a href=https://www.itcodar.com/sql/best-way-to-test-sql-queries.html target=_blank rel=noopener>Debes tener una forma rápida de reconstruir la base de datos de desarrollo</a>
porque es tan fácil echarla a perder
que debes suponer que tiene problemas.</p><p>La complicación adicional que tiene verificar las consultas
es que su resultado depende del conjunto de dato con que se ejecutan,
así que conviene probarlas sobre un conjunto de datos conocido.
Parece que <a href=https://dbunit.sourceforge.net/ target=_blank rel=noopener>DbUnit</a> (<a href=https://iditect.com/article/dbunit.html target=_blank rel=noopener>tutorial</a>)
<a href=https://stackoverflow.com/questions/754527/best-way-to-test-sql-queries/754540#754540 title="DbUnit puede generar pruebas unitarias para SQL." target=_blank rel=noopener>carga la información de un respaldo entre pruebas</a>.</p><p>En ocasiones puede ser difícil mantener las pruebas actualizadas
<a href=https://stackoverflow.com/a/2192532/10467443 target=_blank rel=noopener>porque los reportes suelen cambiar sus objetivos constantemente</a>.</p><p><a href=https://www.itcodar.com/sql/best-way-to-test-sql-queries.html target=_blank rel=noopener>Cada usuario debe tener su propia base de datos
para asegurarse de que los resultados son correctos</a>.</p><p><a href=https://gojko.net/2007/11/20/fighting-the-monster/ target=_blank rel=noopener>El desarrollo orgánico de bases de datos puede desacelerar el desarrollo
por inconsistencias entre interfaces
y sobrepeso agregado</a>.</p><h2 id=refactorizar-bases-de-datos><a href=#refactorizar-bases-de-datos alt>Refactorizar bases de datos </a><a href=# alt="Regresar al inicio">↑</a></h2><p>Atomizar los cambios grandes en pequeños pasos,
para cada paso dar aviso a los involucrados,
negociar con ellos plazos
y mecanismos para cambiar.</p><p>Generar un plan de transición,
comentar en la base de datos los cambios,
asignar una fecha para la transición.</p><p>Una de la mejores herramientas para la transición son los <code>triggers</code>.</p><h2 id=herramientas-para-pruebas-unitarias-sql><a href=#herramientas-para-pruebas-unitarias-sql alt>Herramientas para pruebas unitarias SQL</a> <a href=# alt="Regresar al inicio">↑</a></h2><ul><li><p><a href=https://dbunit.sourceforge.net/ target=_blank rel=noopener>DbUnit</a></p><p>Escrita en Java,
usa XML para declarar la información origen,
y carga el respaldo entre cada prueba.
Es una extensión de JUnit.</p></li><li><p><a href=https://sqlunit.sourceforge.net/ target=_blank rel=noopener>SQLUnit</a></p><p>Escrita en Java.</p></li><li><p><a href=https://github.com/aevdokimenko/tsqlunit target=_blank rel=noopener>TSQLUnit</a></p><p>Al parecer es un framework para pruebas unitarias
escrito en Transact-SQL.</p></li><li><p><a href=https://dbfit.github.io/dbfit/index.html target=_blank rel=noopener>DbFit</a></p><p>Un framework para generar pruebas unitarias y de integración
para el código de la base de datos.</p></li></ul><h2 id=otras-herramientas-para-trabajar-sql><a href=#otras-herramientas-para-trabajar-sql alt>Otras herramientas para trabajar SQL</a> <a href=# alt="Regresar al inicio">↑</a></h2><ul><li><p><a href=https://cosette.cs.washington.edu/ target=_blank rel=noopener>Cossette</a>
verifica que dos consultas SQL son equivalentes.</p></li><li><p><a href=https://querycert.github.io/index.html target=_blank rel=noopener>Q*cert</a>
es un compilador de consultas.</p></li><li><p><a href=https://launchpad.net/randgen target=_blank rel=noopener>Random Query Generator</a>
genera código SQL pseudo aleatorio para probar
conectores a base de datos
(<a href=https://github.com/RQG/RQG-Documentation/wiki/Category%3ARandomQueryGenerator target=_blank rel=noopener>docs</a>).</p></li><li><p><a href=https://duckdb.org/why_duckdb target=_blank rel=noopener>DuckDB</a>
para hacer análisis sobre bases de datos
se usan consultas complejas
que pueden leer varias veces la base de datos entera
si no se optimizan.
En esos casos, conviene usar DuckDB,
que optimiza esa clase de consultas internamente.</p></li></ul><h2 id=bases-de-datos-efímeras><a href=#bases-de-datos-ef%c3%admeras alt>Bases de datos efímeras</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Para probar inserciones en bases de datos
no conviene usar la base de dato productiva porque se dejan valores inválidos.</p><p>Si al generar una base de datos para control de calidad se usan valores aleatorios,
los datos que generas no sirven para validar,
porque no tienes control de los datos.</p><p>Por eso, se puede usar <a href=https://github.com/b-fuze/ephemeral-db/ target=_blank rel=noopener>una base de datos efímera</a>
que cargue el esquema que deseas probar
(preferentemente en memoria).</p><ol><li>Generar datos ficticios con los que puedes probar tu query.</li><li>Verificar que la respuesta del query es como esperas.</li></ol><p>Una posible solución a estos problemas es
generar pruebas unitarias en una DB que vive en RAM.</p><p><a href=https://eradman.com/posts/ephemeral-databases.html target=_blank rel=noopener>La biblioteca <code>testing.postgresql</code> automatiza este proceso</a> en postgresql
(<a href=https://stackoverflow.com/a/48815977 target=_blank rel=noopener>ejemplo</a>).</p><p>También se pueden usar
<a href=https://github.com/b-fuze/ephemeral-db target=_blank rel=noopener>estos scripts para generar bases de datos efímeras</a> en postgres o mysql.</p><h3 id=usar-base-de-datos-efímera-para-testing><a href=#usar-base-de-datos-ef%c3%admera-para-testing alt>Usar base de datos efímera para testing</a> <a href=# alt="Regresar al inicio">↑</a></h3><p>Para probar consultas a la base de datos,
se pueden generar datos ficticios.</p><p>Los datos ficticios se pueden generar en excel
y guardar en formato CSV para verificarlos.</p><p>Para importar los datos CSV a una tabla
<a href=https://stackoverflow.com/a/17071108/10467443 target=_blank rel=noopener>se puede usar <code>mysqlimport</code></a>
o <a href=https://dev.mysql.com/doc/refman/8.0/en/load-data.html target=_blank rel=noopener>la sentencia <code>LOAD DATA</code></a>.
(También hay <a href=https://stackoverflow.com/questions/3635166/how-do-i-import-csv-file-into-a-mysql-table target=_blank rel=noopener>herramientas gráficas para importar datos tabulados a SQL</a>.)</p><h3 id=estoy-implementando-una-biblioteca-para-probar-consultas-en-mysql><a href=#estoy-implementando-una-biblioteca-para-probar-consultas-en-mysql alt>Estoy implementando una <a href=https://gitlab.com/xihh87/testing.mysql target=_blank rel=noopener>biblioteca para probar consultas en mysql</a></a> <a href=# alt="Regresar al inicio">↑</a></h3><p><a href=https://py-pkgs.org/05-testing.html#fixtures target=_blank rel=noopener>Cuando las pruebas unitarias requieren preparación, se pueden usar <code>fixtures</code> en <code>pytest</code></a>.
<a href=https://pytest.org/en/7.4.x/explanation/fixtures.html#about-fixtures target=_blank rel=noopener>Los fixtures se ejecutan consistentemente en las pruebas donde se incluyan</a>,
o por defecto en todas las pruebas <a href=https://pytest.org/en/7.4.x/how-to/fixtures.html#autouse-fixtures-fixtures-you-don-t-have-to-request target=_blank rel=noopener>si se utiliza <code>autouse=True</code></a>.</p><p><a href=https://pytest.org/en/7.4.x/how-to/xunit_setup.html target=_blank rel=noopener>Para hacer pruebas en clases se pueden especificar los métodos <code>setup_class</code> y <code>teardown_class</code> para la clase especificada</a>.
Sospecho que además, los métodos que se revisen deberían indicar como métodos de la clase,
pero aún no encuentro documentación al respecto.</p><p>Si entendí bien mi lectura acerca de cómo se usa el código,
para generar una vez el contenedor y ejecutarlo por la sesión podría:</p><ul><li><input checked disabled type=checkbox> Agregar un <a href=https://pytest.org/en/7.4.x/how-to/fixtures.html#autouse-fixtures-fixtures-you-don-t-have-to-request target=_blank rel=noopener>fixture con autouse</a> y <a href=https://pytest.org/en/7.4.x/how-to/fixtures.html#scope-sharing-fixtures-across-classes-modules-packages-or-session target=_blank rel=noopener>alcance por sesión</a>.</li><li><input checked disabled type=checkbox> <a href=https://pytest.org/en/7.4.x/how-to/fixtures.html#adding-finalizers-directly target=_blank rel=noopener>Agregar un finalizador a mi fixture</a>.</li></ul><hr><p><a href=https://github.com/pytest-dev/pytest/issues/5243 target=_blank rel=noopener>Se pueden agregar fixtures que capturen señales para finalizar</a> (<a href=https://github.com/pytest-dev/pytest/issues/5243#issuecomment-491522595 target=_blank rel=noopener>ejemplo</a>).</p><h2 id=cómo-verificar-inserts><a href=#c%c3%b3mo-verificar-inserts alt>Cómo verificar INSERTs</a> <a href=# alt="Regresar al inicio">↑</a></h2><ul><li><p>Generar una consulta que debería encontrar el registro insertado.</p></li><li><p>Verificar que antes del insert no existe el registro.</p></li><li><p>Verificar que después del insert existe.</p></li><li><p>Eliminar los registros generados.</p></li></ul><h2 id=convertir-volcados-de-tablas-de-base-de-datos-en-csv><a href=#convertir-volcados-de-tablas-de-base-de-datos-en-csv alt>Convertir volcados de tablas de base de datos en CSV</a> <a href=# alt="Regresar al inicio">↑</a></h2><p><a href=https://stackoverflow.com/questions/20700620/convert-massive-mysql-dump-file-to-csv target=_blank rel=noopener>Pueden utilizarse estos scripts para generar una tabla a partir del volcado de la base de datos</a>:</p><pre tabindex=0><code>/^INSERT/ {
    line=$0
    while (match (line,/[^(]*\(([^)]*)\)/,a)) {
        line=substr(line,RSTART+RLENGTH)
        match(a[1],/&#39;([^&#39;]*)&#39;,&#39;([^&#39;]*)&#39;/,b)
        print b[1]
        print b[2]
    }
}
</code></pre><h2 id=herramientas-para-flujos-extraer-transformar-cargar><a href=#herramientas-para-flujos-extraer-transformar-cargar alt>Herramientas para flujos Extraer-Transformar-Cargar</a> <a href=# alt="Regresar al inicio">↑</a></h2><ul><li><a href=https://www.talend.com/products/talend-open-studio/ target=_blank rel=noopener>Talend Open Studio</a></li><li><a href=https://help.hitachivantara.com/Documentation/Pentaho/7.1/0D0/Pentaho_Data_Integration target=_blank rel=noopener>Pentaho</a></li><li><a href=https://www.singer.io/ target=_blank rel=noopener>Singer</a></li><li><a href=https://hadoop.apache.org/ target=_blank rel=noopener>Hadoop</a></li></ul><h2 id=usar-procedimientos-en-la-base-de-datos><a href=#usar-procedimientos-en-la-base-de-datos alt>¿Usar procedimientos en la base de datos?</a> <a href=# alt="Regresar al inicio">↑</a></h2><h3 id=ventajas><a href=#ventajas alt>Ventajas</a> <a href=# alt="Regresar al inicio">↑</a></h3><ul><li>Centralizados y disponibles para cada aplicación.</li><li>Pueden apoyarse con ACL.</li></ul><h3 id=desventajas><a href=#desventajas alt>Desventajas</a> <a href=# alt="Regresar al inicio">↑</a></h3><ul><li>Difíciles de mantener: es necesario eliminarlos y volverlos a crear.</li><li>Puede que distintas áreas de negocio evolucionen requerimientos diferentes.</li></ul><h3 id=cómo-cambiar-procedimientos><a href=#c%c3%b3mo-cambiar-procedimientos alt>Cómo cambiar procedimientos</a> <a href=# alt="Regresar al inicio">↑</a></h3><p><a href=https://stackoverflow.com/questions/13970258/how-to-alter-a-stored-procedure-in-mysql target=_blank rel=noopener>Los procedimientos no se pueden actualizar, se deben regenerar</a>.</p><h2 id=generar-datos-para-probar-consultas><a href=#generar-datos-para-probar-consultas alt>Generar datos para probar consultas</a> <a href=# alt="Regresar al inicio">↑</a></h2><p><a href=https://giis.uniovi.es/testing/papers/stvr-2010-sqlfpc.pdf title=[@doi:10.1002/stvr.424] target=_blank rel=noopener>Supuestamente hay métodos para diseñar información
para cubrir todos los casos de la consulta</a>.</p><h2 id=optimizar-inicio-de-mysql><a href=#optimizar-inicio-de-mysql alt>Optimizar inicio de mysql</a> <a href=# alt="Regresar al inicio">↑</a></h2><p>Dado que uso un contenedor con mysql que tarda alrededor de 20s para iniciar
para verificar que mis consultas son correctas,
mis pruebas de consultas tienen ese overhead.</p><p><a href=https://www.uv.es/jordi/v3/mysql/manual/manual_Performance.html#Server_parameters target=_blank rel=noopener>Hay varias cosas que pueden hacerse para optimizar MySQl</a>:</p><ul><li><p>Compilar estáticamente, sin <code>libstdc++</code>,
optimizando (<code>-O6</code>),
desactivando debug, log, frame pointer <code>-fomit-frame-pointer</code>
y únicamente con el CHARSET que usas.</p></li><li><p>Opción <code>--skip-locking</code> si hay un único servidor
(requiere lock manual al usar <code>mysqmchk</code>).</p></li><li><p>Configurar <code>key_buffer_size</code> y <code>table_cache</code>
y <a href=https://www.uv.es/jordi/v3/mysql/manual/manual_Performance.html#Server_parameters target=_blank rel=noopener>demás configuración del servidor</a>.</p></li><li><p>Puede desactivarse el DNS <code>--skip-name-resolve</code></p></li><li><p><a href=https://hevodata.com/learn/docker-mysql/#What_is_the_Advantage_of_Running_a_Docker_MySQL_Container target=_blank rel=noopener>INITDB SKIP TZINFO</a></p></li></ul><p>La inicialización del sistema tarda alrededor de 8s.
Tal vez generando una imagen que haya terminado la <a href=https://dev.mysql.com/doc/refman/8.0/en/data-directory-initialization.html target=_blank rel=noopener>inicialización del sistema</a>
pueda ejecutar consultas más rápidamente.</p><p><a href=https://dev.mysql.com/doc/refman/5.7/en/mysql-install-db.html target=_blank rel=noopener>Antes había un programa independiente para generar la base de datos (<code>mysql_install_db</code>)
pero se incorporó a <code>mysqld --initialize</code></a>.</p><h2 id=otras-optimizaciones><a href=#otras-optimizaciones alt>Otras optimizaciones</a> <a href=# alt="Regresar al inicio">↑</a></h2><ul><li>Optimizar los discos para escritura.</li></ul><p>El rendimiento de una base de datos no depende de cuántos datos tenga
sino de qué tanto de la base de datos tiene que leer o escribir
(<a href=https://dba.stackexchange.com/questions/22888/how-database-size-affects-performance-theory-vs-reality target=_blank rel=noopener>ejemplos</a>).</p><h2 id=enlaces-interesantes><a href=#enlaces-interesantes alt>Enlaces interesantes</a> <a href=# alt="Regresar al inicio">↑</a></h2><ul><li><a href=https://snapshooter.com/learn/mysqldump-ultimate-guide target=_blank rel=noopener>Guía de mysqldump</a>.</li><li><a href=https://bobcares.com/blog/mysqldump-error-2020/ target=_blank rel=noopener>Se puede usar por tamaño de paquete para evitar el error
<code>2020: Got packet bigger than 'max allowed package'</code></a>.</li><li><a href=https://severalnines.com/blog/my-mysql-database-corrupted-what-do-i-do-now target=_blank rel=noopener>Guía para corregir errores de corrupción en mysql</a>.</li><li><a href=https://hoststud.com/resources/how-to-fix-the-mysqldump-got-error-1044-error-when-selecting-database.841/ target=_blank rel=noopener>El error <code>1044: Access denied…</code> puede corregirse con <code>-single-transaction</code></a></li></ul><h2 id=fuentes-de-información><a href=#fuentes-de-informaci%c3%b3n alt>Fuentes de información</a> <a href=# alt="Regresar al inicio">↑</a></h2><ol><li><p><em>Refactoring Databases: Evolutionary Database Design</em>
—Ambler, Scott W. et al. (2006)
ISBN: 0321293533</p></li><li><p><em>Data and reality: a timeless perspective on perceiving and managing information in our imprecise world</em>
—William Kent, Steve Hoberman Technics Publications (2012)
ISBN: 9781935504214</p></li><li><p><em>Designing data-intensive applications: the big ideas behind reliable, scalable, and maintainable systems</em>
—Martin Kleppmann O’Reilly Media (2017)
ISBN: 9781449373320</p></li></ol></article></main></body></html>