<!doctype html><html lang=es-mx><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Usar una conexión TLS para encapsular SSH</title><link rel=stylesheet media=screen href=https://joshua.haase.mx/css/theme.min.c631e12f4e2b4b8b5282c3d94590678b7a225e8caccee02c0d37dac1838d6a61.css integrity="sha256-xjHhL04rS4tSgsPZRZBni3oiXoyszuAsDTfawYONamE="></head><body><main><article><h1>Usar una conexión TLS para encapsular SSH</h1><nav id=TableOfContents></nav><p>Resulta, que no puedo usar SSH desde la red de mi trabajo
porque las conexiones cifradas que no son HTTPS se bloquean.</p><p>Como necesito acceder a ciertos recursos del exterior,
estoy configurando un proxy de SSH encapsulado en TLS.</p><p>Investigando encontré ejemplos para
<a href=https://iyzico.engineering/proxy-ssh-using-tls-sni-and-nginx-8a18f93f709 target=_blank rel=noopener><code>nginx</code></a>
o <a href=https://vadosware.io/post/stuffing-both-ssh-and-https-on-port-443-with-stunnel-ssh-and-traefik/ target=_blank rel=noopener><code>stunnel</code> + <code>sshl</code> + <code>traefik</code></a>.</p><p>También se puede usar <a href=https://www.stunnel.org/ target=_blank rel=noopener>stunnel</a>
para agregar directamente TLS a SSH.</p><p>Tengo varios servicios en mi servidor y
por eso, tenía que agregar este servicio,
como además quiero usar un servidor para mostrar contenido estático,
<a href=https://iyzico.engineering/proxy-ssh-using-tls-sni-and-nginx-8a18f93f709 target=_blank rel=noopener>me decidí por <code>nginx</code></a>:</p><pre tabindex=0><code>…
stream {
  tcp_nodelay on;
  resolver 8.8.8.8;
  resolver_timeout 5s;

  map $ssl_server_name $srv_name {
    ~(.+)\.ssh $1:22;
    default unix:/run/nginx.sock;
  }

  server {
    listen       443 ssl;
    ssl_certificate	/etc/nginx/certs/fullchain.pem;
    ssl_certificate_key	/etc/nginx/certs/privkey.pem;
    ssl_preread on;
    proxy_ssl off;
    proxy_pass $srv_name;
  }
}
</code></pre><p>Probé que el servicio funcionaba independientemente,
pero mi intento de conexión desde el proxy no funcionaba porque
<a href=https://stackoverflow.com/a/60858441/10467443 target=_blank rel=noopener><code>traefik</code> no puede usar wildcards para sub-dominios en reglas <code>HostSNI</code></a>,
por lo que deben especificarse los subdominios manualmente:</p><pre tabindex=0><code>services:
  nginx:
    …
    expose:
      - 443
    labels:
      - traefik.tcp.routers.proxy_ssh.rule=HostSNI(`dominio-1.ssh`, `dominio-2.ssh`, …, `dominio-n.ssh`)
      - traefik.tcp.routers.proxy_ssh.entrypoints=https
      - traefik.tcp.routers.proxy_ssh.tls.passthrough=true
      - traefik.tcp.routers.proxy_ssh.service=proxy_ssh
      - traefik.tcp.services.proxy_ssh.loadbalancer.server.port=443
</code></pre><p>Especificar los dominios manualmente:</p><ul><li>permite especificar a dónde está permitido acceder desde este proxy,</li><li>aumenta la complejidad de la administración del servicio.</li></ul><p>Para usar este servicio,
se <a href=https://iyzico.engineering/proxy-ssh-using-tls-sni-and-nginx-8a18f93f709 target=_blank rel=noopener>debe configurar el proxy</a>:</p><pre tabindex=0><code># file: ~/.ssh/config
…
Host	*.ssh
	ProxyCommand openssl s_client -quiet -servername %h -connect dominio-de-tu-servidor:443
</code></pre></article></main></body></html>